<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>章鱼机（星星版本）</title>
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
	</head>
    <script src="dexie.min.js"></script>
	<script src="jszip.min.js"></script>

    <style>
        /* --- 全局与主题样式 (支持一键换肤) --- */
        :root {
            /* 全局色彩 */
            --bg-color-main: #fdf1c8;
            --bg-image-main: url('image/默认加载.jpg');
            --primary-color: #e75f70;
            --secondary-color: #e86f7f;
            --text-color: #424242;
            --top-pinned-bg: #ffd1d3;
            --white-color: #ffffff;
            --online-status-color: #4CAF50;
            --home-clock-bg: url(image/时钟.png);
            --home-clock-text: #f65f75;
            --input-area-bg: #ffffff;
            --input-area-border: 3px solid #ed6580;
            --input-text-color: #e1537a;
            --tutorial-border-color: #e75f70;
            --btn-secondary-bg: #e75f70;
            --modal-bg-image: url('image/背景.jpg');
            --border-radius: 18px;
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --bg-color: #ffffff;
            --accent-color: var(--primary-color);
            --page-bg-color: #ffffff;
        }

        .phone-screen {
            background-color: var(--bg-color-main) !important;
            background-image: var(--bg-image-main) !important;
        }

        .app-header .back-btn,
        .app-header .action-btn,
        .app-header .title-container .title {
            color: var(--primary-color) !important;
        }

        .btn-primary {
            background-color: var(--primary-color) !important;
            border: 1px solid var(--secondary-color) !important;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            border-color: var(--primary-color) !important;
            color: var(--text-color) !important;
        }

        .time-widget {
            background-image: var(--home-clock-bg) !important;
        }

        .time-widget .time,
        .time-widget .date {
            color: var(--home-clock-text) !important;
        }

        .message-input-area input {
            background-color: var(--input-area-bg) !important;
            border: var(--input-area-border) !important;
            color: var(--input-text-color) !important;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .phone-screen {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 850px;
            background-color: #fdf1c8;
             background-image: var(--bg-image-main);
            background-repeat: no-repeat;
            background-size: 100% 100%;
            background-position: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #chat-room-screen {
            background-color: #ffffff;
			background-image: var(--chat-bg-default);
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: transparent;
            border-bottom: none;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .app-header .back-btn,
        .app-header .action-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-header .action-btn-group .action-btn {
            font-size: 16px;
            font-weight: 600;
            width: auto;
            padding: 6px 12px;
            border-radius: 10px;
        }

        .app-header .action-btn-group #add-chat-btn {
            font-size: 28px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
        }

        .app-header .action-btn img {
            width: 36px;
            height: auto;
            object-fit: contain;
        }

        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 15px;
            z-index: 5;
            pointer-events: none;
        }

        .app-header .title {
            font-size: 18px;
            font-weight: 900;
            color: #502b02;
            margin: 0;
            text-align: center;
            width: 100%;
        }

        .app-header .subtitle {
            font-size: 12px;
            color: var(--chat-subtitle-color, #ffffff) !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
            width: 100%;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        .app-header .placeholder {
            width: 40px;
        }

        #home-screen {
			background-image: var(--home-wallpaper);
            justify-content: flex-start;
            align-items: center;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 0;
        }

        .time-widget {
            margin-top: 12vh;
            padding-top: 75px;
            background-image: url('image/默认加载.jpg');
            background-size: 95% auto;
            background-repeat: no-repeat;
            background-position: center top;
            width: 320px;
            height: 320px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }

        .time-widget .time {
            font-size: 72px;
            font-weight: 600;
            color: #92530e;
            line-height: 0.9;
            margin-bottom: 5px;
        }

        .time-widget .date {
            font-size: 18px;
            color: #92530e;
            font-weight: bold;
            margin-top: 3px;
        }

        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .home-layout-container {
            width: 90%;
            max-width: 380px;
            margin: 0 auto;
            margin-top: 20px;
        }

        .home-app-grid {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            justify-content: center;
            gap: 40px;
            padding-bottom: 30px;
        }

        .app-icon {
            display: block;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 18px;
            overflow: hidden;
            transition: transform 0.1s;
            box-shadow: none !important;
            background: none !important;
            margin: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 18px;
        }

        .app-icon:active {
            transform: scale(0.95);
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background-image: var(--modal-bg-image);
            background-size: cover;
            background-repeat: no-repeat;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.4s ease-out;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background-image: var(--modal-bg-image); 
            background-size: cover;
            background-repeat: no-repeat;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #chat-list-screen .content,
        #world-book-screen .content {
            padding: 10px 0 0 0;
        }

        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color: #fdf6f8;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: 10px;
            transition: padding-bottom 0.3s ease;
        }

        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 2px;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
            align-items: flex-start;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        .message-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 7px;
            object-fit: cover;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }

        .message-bubble {
            max-width: 260px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.4;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 15px;
            cursor: pointer;
            font-size: 15px;
        }

        .message-bubble.sent {
            border-bottom-right-radius: 5px;
        }

        .message-bubble.received {
            border-bottom-left-radius: 5px;
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .image-bubble {
            max-width: 120px;
            border-radius: var(--border-radius);
            margin: 0 8px;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .image-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: calc(var(--border-radius) - 4px);
        }

        .message-wrapper.sent .image-bubble {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .image-bubble {
            border-bottom-left-radius: 5px;
        }

        .pv-card {
            width: 230px;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0 8px;
        }

        .message-wrapper.sent .pv-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .pv-card {
            border-bottom-left-radius: 5px;
        }

        .pv-card-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }

        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .pv-card-footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .pv-card-footer.hidden {
            opacity: 0;
        }

        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

        #sticker-modal {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            max-height: 250px;
            background-image: var(--modal-bg-image);
            background-size: cover;
            background-repeat: no-repeat;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 25;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
        }

        #sticker-bar {
            flex-shrink: 0;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            background: transparent;
            backdrop-filter: none;
            margin-bottom: -13px;
        }

        .sticker-bar-btn {
            background: transparent !important;
            border: none !important;
            padding: 5px;
        }

        .sticker-bar-btn img {
            width: 26px;
            height: 26px;
            object-fit: contain;
        }

        .message-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: none;
            background: transparent;
            backdrop-filter: none;
            flex-shrink: 0;
            gap: 10px;
        }

        .message-input-area input {
            flex-grow: 1;
            border: 3px dashed #64380a;
            padding: 12px 15px;
            border-radius: 20px;
            background-color: #fff6de;
            font-size: 15px;
            color: #64380a;
        }

        .message-input-area input:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(100, 56, 10, 0.3);
        }

        .message-input-area .icon-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .message-input-area .icon-btn:hover {
            transform: scale(1.1);
        }

        #get-reply-btn img {
            height: 45px;
            width: 45px;
            display: block;
            margin-bottom: 1px;
            margin-left: -1px;
        }

        #send-message-btn img {
            height: 48px;
            width: 48px;
            display: block;
            margin-bottom: 2px;
        }

        #summary-manager-modal {
            z-index: 200 !important;
        }

        .summary-card {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .summary-time {
            font-size: 12px;
            color: #ff80ab;
            font-weight: bold;
        }

        .summary-content {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .summary-actions {
            display: flex;
            gap: 8px;
        }

        .summary-btn {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .edit-sum-btn {
            background: #90caf9;
            color: white;
        }

        .del-sum-btn {
            background: #ef5350;
            color: white;
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .settings-sidebar {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            height: 100%;
            background-image: var(--modal-bg-image);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.4s ease-in-out;
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        .settings-sidebar .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-sidebar .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .settings-sidebar .avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-sidebar .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group .toggle-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-group .toggle-label label {
            margin-bottom: 0;
        }

        .form-group .toggle-label input[type="checkbox"] {
            width: auto;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #92530e;
            color: #92530e;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group.radio-group label {
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: #92530e;
            color: #fff;
            border: 1px solid #7a490b;
        }

        .btn-primary:hover {
            background-color: #7a490b;
            box-shadow: 0 4px 15px rgba(146, 83, 14, 0.4);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: var(--white-color);
            margin-bottom: 15px;
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #fff8fa;
        }

        .toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        #world-book-selection-modal {
            z-index: 102;
        }

        #world-book-selection-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }

        #world-book-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .tutorial-item {
            border: 2px solid var(--tutorial-border-color);
            margin-bottom: 15px;
            border-color: var(--tutorial-border-color, #92530e);
            border-radius: 12px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .tutorial-header {
            padding: 12px 18px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-header::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }

        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }

        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            max-height: 5000px;
        }

        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .ts-history-item {
            background: #fdf6f8;
            border-bottom: 1px solid #eee;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            color: #555;
            line-height: 1.4;
            transition: background-color 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .ts-history-item:active {
            background-color: #f0e0e4;
        }

        .ts-history-time {
            font-size: 11px;
            color: #ed597c;
            margin-bottom: 4px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="phone-screen">
        <div id="home-screen" class="screen active"></div>
        <div id="chat-list-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">聊天</h1>
                </div>
                <div class="action-btn-group">
                    <button class="action-btn" id="add-chat-btn">+</button>
                </div>
            </header>
            <main class="content">
                <ul class="list-container" id="chat-list-container"></ul>
                <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                    <p>还没有聊天对象哦~</p>
                    <p>点击右上角的“+”创建一个吧！</p>
                </div>
            </main>
        </div>
        <div id="chat-room-screen" class="screen">
            <header class="app-header" id="chat-room-header-default">
                <button class="back-btn" data-target="chat-list-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="chat-room-title">...</h1>
                    <div class="subtitle" id="chat-room-subtitle">
                        <div class="online-indicator"></div>
                        <span id="chat-room-status-text">在线</span>
                    </div>
                </div>
                <button class="action-btn" id="chat-settings-btn"><img src="image/设置.png" alt="设置"></button>
            </header>
            <header class="app-header" id="chat-room-header-select" style="display: none;">
                <button class="action-btn" id="cancel-multi-select-btn">取消</button>
                <div class="title-container">
                    <h1 class="title" id="multi-select-title">选择消息</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <div id="chat-notes-layer"></div>
            <main class="content">
                <div class="message-area" id="message-area"></div>
                <div class="typing-indicator" id="typing-indicator"></div>
            </main>
            <div class="chat-input-wrapper">

                <div id="sticker-bar">
                    <button class="sticker-bar-btn" id="sticker-toggle-btn">
                        <img src="image/表情.png" alt="表情">
                    </button>
                    <button class="sticker-bar-btn" id="photo-video-btn">
                        <img src="image/相册.png" alt="照片视频">
                    </button>
                    <button class="sticker-bar-btn" id="image-recognition-btn">
                        <img src="image/文件.png" alt="图片">
                    </button>
                    <button class="sticker-bar-btn" id="time-skip-btn">
                        <img src="image/记录.png" alt="记录">
                    </button>
                </div>

                <div class="message-input-area" id="message-input-default">
                    <button id="get-reply-btn" class="icon-btn">
                        <img src="image/AI回复.png" alt="AI回复">
                    </button>
                    <input type="text" id="message-input" placeholder="输入消息...">
                    <button id="send-message-btn" class="icon-btn send-btn">
                        <img src="image/发送.png" alt="发送">
                    </button>
                </div>

                <div class="message-input-area" id="message-edit-bar" style="display: none;">
                    <input type="text" id="message-edit-input">
                    <button id="save-edit-btn" class="icon-btn send-btn">✓</button>
                    <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
                </div>
            </div>
            <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
                <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
                </button>
            </div>
            <div id="sticker-modal">
                <div class="header"><span>我的表情</span>
                    <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>
                </div>
                <div class="sticker-grid" id="sticker-grid-container"></div>
            </div>
        </div>
		
		<!-- 图片查看器模态框 -->
		    <div id="image-viewer-modal" class="modal-overlay" style="z-index: 2000; background-color: rgba(0,0,0,0.95);">
		        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative;">
		            <img id="image-viewer-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s;">
		        </div>
		</div>
        <div id="world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">世界书</h1>
                </div>
                <button class="action-btn" id="add-world-book-btn">+</button>
            </header>
            <main class="content">
                <ul class="list-container" id="world-book-list-container"></ul>
                <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                    <p>你的世界一片混沌...</p>
                    <p>点击右上角的“+”创造第一个设定吧！</p>
                </div>
            </main>
        </div>
        <div id="edit-world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="world-book-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <form id="edit-world-book-form">
                    <input type="hidden" id="world-book-id">
                    <div class="form-group">
                        <label for="world-book-name">条目名称</label>
                        <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                    </div>
                    <div class="form-group">
                        <label for="world-book-content">条目内容</label>
                        <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>注入位置</label>
                        <div class="form-group radio-group">
                            <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                            <label><input type="radio" name="world-book-position" value="after"> 后</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">保存条目</button>
                </form>
            </main>
        </div>
        <div id="api-settings-screen" class="screen"></div>
        <div id="wallpaper-screen" class="screen"></div>
        <div id="font-settings-screen" class="screen"></div>
        <div id="tutorial-screen" class="screen"></div>

        <div id="toast-notification" class="toast"></div>
        <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
        <div id="add-char-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建新角色</h3>
                <form id="add-char-form">
                    <div class="form-group">
                        <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                            placeholder="角色的真实姓名" required>
                    </div>
                    <div class="form-group">
                        <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                            placeholder="你对Ta的称呼" required>
                    </div>
                    <div class="form-group">
                        <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                            placeholder="你希望Ta如何称呼你" required>
                    </div>
                    <button type="submit" class="btn btn-primary">创建</button>
                </form>
            </div>
        </div>
        <div id="add-sticker-modal" class="modal-overlay">
            <div class="modal-window">
                <h3 id="add-sticker-modal-title">添加新表情</h3>
                <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                    <div id="sticker-preview"><span>预览</span></div>
                    <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                            placeholder="如：开心" required>
                    </div>
                    <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                            id="sticker-url-input" placeholder="粘贴图片URL">
                    </div>
                    <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file"
                        id="sticker-file-upload" accept="image/*" style="display:none;"><label for="sticker-file-upload"
                        class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>
        <div id="sticker-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
                <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
            </div>
        </div>

        <div id="send-pv-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>分享照片/视频</h3>
                <form id="send-pv-form">
                    <div class="form-group">
                        <label for="pv-text-input">输入描述</label>
                        <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="time-skip-modal" class="modal-overlay">
            <div class="modal-window" style="position: relative; overflow: hidden;">
                <button id="ts-history-btn" type="button"
                    style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--secondary-color); z-index: 10;">
                    ⚙️
                </button>

                <div id="ts-form-view">
                    <h3>记录今天发生的事</h3>
                    <form id="time-skip-form">
                        <div class="form-group">
                            <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                            <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                                rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">发送</button>
                    </form>
                </div>

                <div id="ts-history-view"
                    style="display: none; flex-direction: column; height: 100%; animation: fadeIn 0.3s;">
                    <h3
                        style="margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                        <button id="ts-history-back-btn" type="button"
                            style="background:none; border:none; font-size:18px; color:var(--primary-color); cursor:pointer;">‹
                            返回</button>
                        今日记录
                        <div style="width: 40px;"></div>
                    </h3>
                    <ul id="ts-history-list"
                        style="list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; max-height: 250px;">
                    </ul>
                    <p style="text-align: center; color: #aaa; font-size: 12px; margin-top: 10px;">长按条目可删除</p>
                </div>
            </div>
        </div>
    </div>

    <div id="summary-manager-modal" class="modal-overlay">
        <div class="modal-window"
            style="width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3>记忆总结管理</h3>
            <div id="summary-list-container"
                style="flex-grow: 1; overflow-y: auto; margin-bottom: 15px; padding: 5px;">
            </div>
            <button class="btn btn-primary" id="close-summary-manager-btn">关闭</button>
        </div>
    </div>

    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                        class="avatar-preview"><input type="file" id="setting-char-avatar-upload" accept="image/*"
                        style="display:none;"><label for="setting-char-avatar-upload" class="btn btn-primary"
                        style="flex-grow:1;">更换角色头像</label></div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                        id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                        class="avatar-preview"><input type="file" id="setting-my-avatar-upload" accept="image/*"
                        style="display:none;"><label for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                        id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea id="setting-my-persona"
                        placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                        style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                        placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                        disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                        style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>

                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                        id="setting-max-memory" value="10" min="1">
                </div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div class="toggle-label">
                        <label for="setting-auto-summary-toggle">自动记忆总结</label>
                        <input type="checkbox" id="setting-auto-summary-toggle" style="width: auto;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-summary-interval">每隔N轮对话总结一次</label>
                    <input type="number" id="setting-summary-interval" value="20" min="5">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="manage-summaries-btn">管理记忆总结列表</button>
                </div>

                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>


    <input type="file" id="import-data-input" accept=".ee" style="display: none;">
    <script>
        // gemini如果是多个密钥, 那么随机获取一个
        function getRandomValue(str) {
            if (str.includes(',')) {
                const arr = str.split(',').map(item => item.trim());
                const randomIndex = Math.floor(Math.random() * arr.length);
                return arr[randomIndex];
            }
            return str;
        }

        document.addEventListener('DOMContentLoaded', () => {
            async function compressImage(file, options = {}) {
                const {
                    quality = 0.8, maxWidth = 800, maxHeight = 800
                } = options;

                if (file.type === 'image/gif') {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                    });
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onerror = reject;
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onerror = reject;
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round(height * (maxWidth / width));
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round(width * (maxHeight / height));
                                    height = maxHeight;
                                }
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');

                            if (file.type === 'image/png') {
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, width, height);
                            }

                            ctx.drawImage(img, 0, 0, width, height);
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(compressedDataUrl);
                        };
                    };
                });
            }

            document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">API 设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API 服务商</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select></div><div class="form-group"><label for="api-url">API 地址（后缀不用添加/v1）</label><input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">选择模型</label><select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select></div><div class="form-group"><label for="api-temperature">AI 温度 (当前: <span id="temp-display-val">1.0</span>)</label><input type="range" id="api-temperature" min="0" max="2" step="0.1" value="1.0" style="width:100%;"> <div style="font-size:12px; color:#888; margin-top:5px; display:flex; justify-content:space-between;"><span>严谨 (0.0)</span><span>平衡 (1.0)</span><span>发癫 (2.0)</span></div></div><button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button></form></main>`;
            document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">更换壁纸</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label></main>`;
            document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;
            document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

            const colorThemes = {
                'white_pink': {
                    name: '白/粉',
                    received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' },
                    sent: { bg: 'rgba(255,204,204,0.9)', text: '#A56767' }
                },
                'white_blue': {
                    name: '白/蓝',
                    received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' },
                    sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' }
                },
                'white_yellow': {
                    name: '白/黄',
                    received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' },
                    sent: { bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B' }
                },
                'white_green': {
                    name: '白/绿',
                    received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' },
                    sent: { bg: 'rgba(188,238,188,0.9)', text: '#4F784F' }
                },
                'white_purple': {
                    name: '白/紫',
                    received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' },
                    sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' }
                },
                'black_red': {
                    name: '黑/红',
                    received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' },
                    sent: { bg: 'rgb(226,62,87,0.9)', text: '#fff' }
                },
                'black_green': {
                    name: '黑/绿',
                    received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' },
                    sent: { bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E' }
                },
                'black_white': {
                    name: '黑/白',
                    received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' },
                    sent: { bg: 'rgba(245,245,245,0.9)', text: '#333' }
                },
                'white_black': {
                    name: '白/黑',
                    received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' },
                    sent: { bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5' }
                },
                'yellow_purple': {
                    name: '黄/紫',
                    received: { bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B' },
                    sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' }
                },
                'pink_blue': {
                    name: '粉/蓝',
                    received: { bg: 'rgba(255,231,240,0.9)', text: '#7C6770' },
                    sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' }
                },
            };

            const APP_THEMES = {
                "pink_cat": {
                    name: "粉色 ",
                    cssVars: {
                        "--bg-image-main": "url('image/背景.jpg')",
						"--modal-bg-image": "url('image/背景.jpg')",
						"--home-wallpaper": "url('image/桌面.jpg')",
						"--chat-bg-default": "url('image/聊天壁纸.jpg')", 
                        "--bg-color-main": "#fdf1c8",
                        "--primary-color": "#e75f70",
                        "--secondary-color": "#e86f7f",
                        "--text-color": "#424242",
                        "--top-pinned-bg": "#ffd1d3",
                        "--home-clock-bg": "url('image/时钟.png')",
                        "--home-clock-text": "#f65f75",
                        "--chat-subtitle-color": "#e86f7f",
                        "--input-area-bg": "#ffffff",
                        "--input-area-border": "3px solid #ed6580",
                        "--input-text-color": "#e1537a",

                    },
                    images: {
                        "home-icon-chat": "image/聊天.png",
                        "home-icon-world": "image/世界书.png",
                        "home-icon-api": "image/apii.png",
                        "home-icon-font": "image/字体.png",
                        "home-icon-tutorial": "image/教程.png",
                        "home-icon-wallpaper": "image/壁纸.png",
                        "chat-settings-icon": "image/设置.png",
                        "btn-icon-reply": "image/AI回复.png",
                        "btn-icon-send": "image/发送.png",
                        "sticker-icon": "image/表情.png",
                        "photo-icon": "image/相册.png",
                        "image-icon": "image/文件.png",
                        "record-icon": "image/记录.png",
                    }
                },
            };

            function applyGlobalTheme(themeId) {
                const theme = APP_THEMES[themeId];
                if (!theme) return;
                const root = document.documentElement;
                for (const [key, value] of Object.entries(theme.cssVars)) {
                    root.style.setProperty(key, value);
                }
                for (const [id, url] of Object.entries(theme.images)) {
                    let el = document.getElementById(id);
                    if (!el && id.endsWith('-icon')) {
                        const btnIdMap = {
                            "sticker-icon": "sticker-toggle-btn",
                            "photo-icon": "photo-video-btn",
                            "image-icon": "image-recognition-btn",
                            "record-icon": "time-skip-btn",
                        };
                        const btnId = btnIdMap[id];
                        if (btnId) {
                            const btn = document.getElementById(btnId);
                            if (btn) el = btn.querySelector('img');
                        }
                    }
                    if (id === "btn-icon-reply") el = document.querySelector('#get-reply-btn img');
                    if (id === "btn-icon-send") el = document.querySelector('#send-message-btn img');
                    if (id === "chat-settings-icon") el = document.querySelector('#chat-settings-btn img');
                    if (el && el.tagName === 'IMG') el.src = url;
                }
                db.globalTheme = themeId;
                saveData();
            }

            let db = {
                moodSignature: '今天也要元气满满哦！',
                characters: [],
                apiSettings: {},
                wallpaper: 'image/桌面.jpg',
                myStickers: [],
                homeScreenMode: 'night',
                worldBooks: [],
                fontUrl: '',
                customIcons: {}
            };
            let currentChatId = null, isGenerating = false, longPressTimer = null,
                isInMultiSelectMode = false, editingMessageId = null, currentPage = 1,
                currentEditingWorldBookId = null, currentStickerActionTarget = null;
            let selectedMessageIds = new Set();

            class DataStorage {
                constructor() {
                    this.db = new Dexie('猫爪机DB');
                    this.db.version(2).stores({
                        storage: 'key, value, timestamp',
                        history: 'id, content, timestamp'
                    });
                }

                async saveData(key, data) {
                    try {
                        const dataToSave = JSON.parse(JSON.stringify(data));
                        if (dataToSave.characters) {
                            dataToSave.characters.forEach(c => {
                                c.history = [];
                            });
                        }
                        const item = {
                            key: key,
                            value: JSON.stringify(dataToSave),
                            timestamp: Date.now()
                        };
                        await this.db.storage.put(item);
                        return true;
                    } catch (error) {
                        console.error('保存主数据失败:', error);
                        return false;
                    }
                }

                async saveHistory(chatId, historyArray) {
                    try {
                        await this.db.history.put({
                            id: chatId,
                            content: JSON.stringify(historyArray),
                            timestamp: Date.now()
                        });
                    } catch (error) {
                        console.error('保存历史记录失败:', error);
                    }
                }

                async getHistory(chatId) {
                    try {
                        const item = await this.db.history.get(chatId);
                        if (item && item.content) {
                            return JSON.parse(item.content);
                        }
                        return [];
                    } catch (error) {
                        return [];
                    }
                }

                async getData(key) {
                    try {
                        const item = await this.db.storage.get(key);
                        return item ? JSON.parse(item.value) : null;
                    } catch (error) {
                        return null;
                    }
                }
            }

            const dataStorage = new DataStorage();

            const saveData = async (data) => {
                const targetDB = data ? data : db;
                if (targetDB.characters) {
                    for (const char of targetDB.characters) {
                        if (char.history && char.history.length > 0) {
                            await dataStorage.saveHistory(char.id, char.history);
                        }
                    }
                }
                await dataStorage.saveData('猫爪机', targetDB);
                return Promise.resolve();
            };

            const loadData = async () => {
                const oldData = localStorage.getItem('gemini-chat-app-db');
                let data = await dataStorage.getData('猫爪机');

                if (oldData) {
                    try {
                        await saveData(JSON.parse(oldData));
                        data = await dataStorage.getData('猫爪机');
                        localStorage.removeItem('gemini-chat-app-db');
                    } catch (e) { }
                }

                if (data) {
                    let needSave = false;
                    if (data.characters) {
                        for (let char of data.characters) {
                            if (char.history && char.history.length > 0) {
                                await dataStorage.saveHistory(char.id, char.history);
                                char.history = [];
                                needSave = true;
                            }
                        }
                    }
                    if (needSave) {
                        await dataStorage.saveData('猫爪机', data);
                    }
                    db = data;
                }

                if (!db) db = {};
                if (!db.apiSettings) db.apiSettings = {};
                if (!db.wallpaper) db.wallpaper = 'image/桌面.jpg';
                if (!db.characters) db.characters = [];
                if (!db.myStickers) db.myStickers = [];
                if (!db.homeScreenMode) db.homeScreenMode = 'night';
                if (!db.worldBooks) db.worldBooks = [];
                if (!db.fontUrl) db.fontUrl = '';
                if (!db.customIcons) db.customIcons = {};

                db.characters.forEach(c => { if (!c.history) c.history = []; });

                return Promise.resolve();
            };

            const screens = document.querySelectorAll('.screen'),
                toastElement = document.getElementById('toast-notification'),
                homeScreen = document.getElementById('home-screen'),
                chatListContainer = document.getElementById('chat-list-container'),
                noChatsPlaceholder = document.getElementById('no-chats-placeholder'),
                addChatBtn = document.getElementById('add-chat-btn'),
                addCharModal = document.getElementById('add-char-modal'),
                addCharForm = document.getElementById('add-char-form'),
                chatRoomScreen = document.getElementById('chat-room-screen'),
                chatRoomHeaderDefault = document.getElementById('chat-room-header-default'),
                chatRoomHeaderSelect = document.getElementById('chat-room-header-select'),
                cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'),
                chatRoomTitle = document.getElementById('chat-room-title'),
                chatRoomStatusText = document.getElementById('chat-room-status-text'),
                messageArea = document.getElementById('message-area'),
                messageInputDefault = document.getElementById('message-input-default'),
                messageInput = document.getElementById('message-input'),
                sendMessageBtn = document.getElementById('send-message-btn'),
                getReplyBtn = document.getElementById('get-reply-btn'),
                typingIndicator = document.getElementById('typing-indicator'),
                chatSettingsBtn = document.getElementById('chat-settings-btn'),
                settingsSidebar = document.getElementById('chat-settings-sidebar'),
                settingsForm = document.getElementById('chat-settings-form'),
                messageEditBar = document.getElementById('message-edit-bar'),
                messageEditInput = document.getElementById('message-edit-input'),
                saveEditBtn = document.getElementById('save-edit-btn'),
                cancelEditBtn = document.getElementById('cancel-edit-btn'),
                multiSelectBar = document.getElementById('multi-select-bar'),
                selectCount = document.getElementById('select-count'),
                deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const stickerToggleBtn = document.getElementById('sticker-toggle-btn'),
                stickerModal = document.getElementById('sticker-modal'),
                stickerGridContainer = document.getElementById('sticker-grid-container'),
                addNewStickerBtn = document.getElementById('add-new-sticker-btn'),
                addStickerModal = document.getElementById('add-sticker-modal'),
                addStickerModalTitle = document.getElementById('add-sticker-modal-title'),
                addStickerForm = document.getElementById('add-sticker-form'),
                stickerEditIdInput = document.getElementById('sticker-edit-id'),
                stickerPreview = document.getElementById('sticker-preview'),
                stickerNameInput = document.getElementById('sticker-name'),
                stickerUrlInput = document.getElementById('sticker-url-input'),
                stickerFileUpload = document.getElementById('sticker-file-upload');
            const stickerActionSheet = document.getElementById('sticker-actionsheet'),
                editStickerBtn = document.getElementById('edit-sticker-btn'),
                deleteStickerBtn = document.getElementById('delete-sticker-btn');

            const photoVideoBtn = document.getElementById('photo-video-btn'),
                sendPvModal = document.getElementById('send-pv-modal'),
                sendPvForm = document.getElementById('send-pv-form'),
                pvTextInput = document.getElementById('pv-text-input');
            const imageRecognitionBtn = document.getElementById('image-recognition-btn'),
                imageUploadInput = document.getElementById('image-upload-input');

            const timeSkipBtn = document.getElementById('time-skip-btn'),
                timeSkipModal = document.getElementById('time-skip-modal'),
                timeSkipForm = document.getElementById('time-skip-form'),
                timeSkipInput = document.getElementById('time-skip-input');
            const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
            const worldBookListContainer = document.getElementById('world-book-list-container'),
                noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'),
                addWorldBookBtn = document.getElementById('add-world-book-btn'),
                editWorldBookScreen = document.getElementById('edit-world-book-screen'),
                editWorldBookForm = document.getElementById('edit-world-book-form'),
                worldBookIdInput = document.getElementById('world-book-id'),
                worldBookNameInput = document.getElementById('world-book-name'),
                worldBookContentInput = document.getElementById('world-book-content');
            const linkWorldBookBtn = document.getElementById('link-world-book-btn'),
                worldBookSelectionModal = document.getElementById('world-book-selection-modal'),
                worldBookSelectionList = document.getElementById('world-book-selection-list'),
                saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
            const fontSettingsForm = document.getElementById('font-settings-form'),
                fontUrlInput = document.getElementById('font-url'),
                restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
            const tutorialContentArea = document.getElementById('tutorial-content-area');

            const showToast = (message) => {
                toastElement.textContent = message;
                toastElement.classList.add('show');
                setTimeout(() => toastElement.classList.remove('show'), 3000);
            };
            const switchScreen = (targetId) => {
                screens.forEach(screen => screen.classList.remove('active'));
                document.getElementById(targetId)?.classList.add('active');
                const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
                overlays.forEach(o => o.classList.remove('visible', 'open'));
            };
            const pad = (num) => num.toString().padStart(2, '0');

            function createContextMenu(items, x, y) {
                removeContextMenu();
                const menu = document.createElement('div');
                menu.className = 'context-menu';
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                items.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'context-menu-item';
                    if (item.danger) menuItem.classList.add('danger');
                    menuItem.textContent = item.label;
                    menuItem.onclick = () => {
                        item.action();
                        removeContextMenu();
                    };
                    menu.appendChild(menuItem);
                });
                document.body.appendChild(menu);
                document.addEventListener('click', removeContextMenu, { once: true });
            }

            function removeContextMenu() {
                const menu = document.querySelector('.context-menu');
                if (menu) menu.remove();
            }

            function updateCustomBubbleStyle(chatId, css, enabled) {
                const styleId = `custom-bubble-style-for-${chatId}`;
                let styleElement = document.getElementById(styleId);

                if (enabled && css) {
                    if (!styleElement) {
                        styleElement = document.createElement('style');
                        styleElement.id = styleId;
                        document.head.appendChild(styleElement);
                    }
                    const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);
                    styleElement.innerHTML = scopedCss;
                } else {
                    if (styleElement) styleElement.remove();
                }
            }

            function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {
                previewContainer.innerHTML = '';
                const sentBubble = document.createElement('div');
                sentBubble.className = 'message-bubble sent';
                sentBubble.textContent = '这是我方气泡。';
                sentBubble.style.alignSelf = 'flex-end';
                sentBubble.style.borderBottomRightRadius = '5px';

                const receivedBubble = document.createElement('div');
                receivedBubble.className = 'message-bubble received';
                receivedBubble.textContent = '这是对方气泡。';
                receivedBubble.style.alignSelf = 'flex-start';
                receivedBubble.style.borderBottomLeftRadius = '5px';

                [sentBubble, receivedBubble].forEach(bubble => {
                    bubble.style.maxWidth = '70%';
                    bubble.style.padding = '8px 12px';
                    bubble.style.wordWrap = 'break-word';
                    bubble.style.lineHeight = '1.4';
                });

                if (useDefault || !css) {
                    sentBubble.style.backgroundColor = theme.sent.bg;
                    sentBubble.style.color = theme.sent.text;
                    sentBubble.style.borderRadius = '18px';
                    sentBubble.style.borderBottomRightRadius = '5px';
                    receivedBubble.style.backgroundColor = theme.received.bg;
                    receivedBubble.style.color = theme.received.text;
                    receivedBubble.style.borderRadius = '18px';
                    receivedBubble.style.borderBottomLeftRadius = '5px';
                } else {
                    const styleTag = document.createElement('style');
                    const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
                    styleTag.textContent = scopedCss;
                    previewContainer.appendChild(styleTag);
                }
                previewContainer.appendChild(receivedBubble);
                previewContainer.appendChild(sentBubble);
            }

            const init = async () => {
                await loadData();
                if (!db.globalTheme) db.globalTheme = 'pink_cat';
                applyGlobalTheme(db.globalTheme);
                document.body.addEventListener('click', (e) => {
                    if (e.target.closest('.context-menu')) {
                        e.stopPropagation();
                        return;
                    }
                    removeContextMenu();

                    const backBtn = e.target.closest('.back-btn');
                    if (backBtn) {
                        e.preventDefault();
                        switchScreen(backBtn.getAttribute('data-target'));
                    }

                    const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                    if (openOverlay && e.target === openOverlay) {
                        openOverlay.classList.remove('visible');
                    }
                });

                document.body.addEventListener('click', e => {
                    const navLink = e.target.closest('.app-icon[data-target]');
                    if (navLink) {
                        e.preventDefault();
                        switchScreen(navLink.getAttribute('data-target'));
                    }
                });

                updateClock();
                setInterval(updateClock, 30000);
                applyGlobalFont(db.fontUrl);
                setupHomeScreen();
                setupChatListScreen();
                setupAddCharModal();
                setupChatRoom();
                setupChatSettings();
                setupApiSettingsApp();
                setupWallpaperApp();
                setupStickerSystem();
                setupPhotoVideoSystem();
                setupImageRecognition();
                setupTimeSkipSystem();
                setupWorldBookApp();
                setupFontSettingsApp();
                setupTutorialApp();
                setupImportSystem();
            };

            function updateClock() {
                const now = new Date();
                const timeDisplay = document.getElementById('time-display');
                const dateDisplay = document.getElementById('date-display');
                if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
                if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;
            }

            function setupHomeScreen() {
                const homeScreenHTML = `
    <div class="time-widget">
        <div class="time" id="time-display"></div>
        <div class="date" id="date-display"></div>
    </div>
    <div class="home-layout-container">
        <div class="home-app-grid">
            <a href="#" class="app-icon" data-target="chat-list-screen">
                <img id="home-icon-chat" src="image/聊天.png">
            </a>
            <a href="#" class="app-icon" data-target="world-book-screen">
                <img id="home-icon-world" src="image/世界书.png">
            </a>
            <a href="#" class="app-icon" data-target="api-settings-screen">
                <img id="home-icon-api" src="image/apii.png">
            </a>
            <a href="#" class="app-icon" data-target="wallpaper-screen">
                <img id="home-icon-wallpaper" src="image/壁纸.png">
            </a>
            <a href="#" class="app-icon" data-target="tutorial-screen">
                <img id="home-icon-tutorial" src="image/教程.png">
            </a>
            <a href="#" class="app-icon" data-target="font-settings-screen">
                <img id="home-icon-font" src="image/字体.png">
            </a>
        </div>
    </div>`;

                homeScreen.innerHTML = homeScreenHTML;
                updateClock();
                applyWallpaper(db.wallpaper);
                applyHomeScreenMode(db.homeScreenMode);

                document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
                document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);

                if (db.globalTheme) applyGlobalTheme(db.globalTheme);
            }

            function applyWallpaper(url) {
                homeScreen.style.backgroundImage = `url(${url})`;
            }

            async function applyHomeScreenMode(mode) {
                if (mode === 'day') {
                    homeScreen.classList.add('day-mode');
                } else {
                    homeScreen.classList.remove('day-mode');
                }
                db.homeScreenMode = mode;
                await saveData();
            }

            function setupTutorialApp() {
                tutorialContentArea.addEventListener('click', (e) => {
                    const header = e.target.closest('.tutorial-header');
                    if (header) {
                        header.parentElement.classList.toggle('open');
                    }
                });
            }
            let loadingBtn = false

            function renderTutorialContent() {
                            const tutorials = [
                                { title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg'] },
                                { title: '软件介绍', imageUrls: ['https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg'] },
                                { title: '404', imageUrls: ['https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg'] },
                            ];
                            tutorialContentArea.innerHTML = '';
                            tutorials.forEach(tutorial => {
                                const item = document.createElement('div');
                                item.className = 'tutorial-item';
                                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title}教程图片">`).join('');
                                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                                tutorialContentArea.appendChild(item);
                            });
            
                            // --- 导出 (备份) 按钮 ---
                            const backupDataBtn = document.createElement('button');
                            backupDataBtn.className = 'btn btn-primary';
                            backupDataBtn.textContent = '导出数据 (ZIP压缩包)';
                            backupDataBtn.style.marginTop = '20px';
                            
                            backupDataBtn.addEventListener('click', async () => {
                                if (typeof JSZip === 'undefined') {
                                    return showToast('错误：未加载 JSZip 库，请检查网络或添加脚本引用。');
                                }
                                if (loadingBtn) return;
                                loadingBtn = true;
                                showToast('正在打包数据...');
            
                                try {
                                    const zip = new JSZip();
            
                                    // 1. 导出对话记录 (按角色名.txt)
                                    if (db.characters) {
                                        for (let char of db.characters) {
                                            const fullHistory = await dataStorage.getHistory(char.id);
                                            if (fullHistory && fullHistory.length > 0) {
                                                let txtContent = "";
                                                fullHistory.forEach(msg => {
                                                    const date = new Date(msg.timestamp);
                                                    const timeStr = `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
                                                    // 格式: [时间] (发送者): 内容
                                                    // 如果是 user，发送者显示 "我" 或者 你的名字，如果是 assistant，显示角色名
                                                    const senderName = msg.role === 'user' ? (char.myName || '我') : char.remarkName;
                                                    // 处理换行符，保持文本整洁
                                                    const cleanContent = msg.content.replace(/\n/g, '\\n'); 
                                                    txtContent += `[${timeStr}] (${senderName}): ${cleanContent}\n`;
                                                });
                                                // 文件名使用角色备注名
                                                const safeFileName = char.remarkName.replace(/[\\/:*?"<>|]/g, "_"); 
                                                zip.file(`${safeFileName}.txt`, txtContent);
                                            }
                                        }
                                    }
            
                                    // 2. 导出世界书和设置 (纯文本)
                                    let settingsTxt = "=== 世界书 (World Books) ===\n\n";
                                    if (db.worldBooks) {
                                        db.worldBooks.forEach(wb => {
                                            settingsTxt += `[名称]: ${wb.name}\n[位置]: ${wb.position}\n[内容]:\n${wb.content}\n--------------------\n`;
                                        });
                                    }
                                    
                                    settingsTxt += "\n=== 基础设置 (Settings) ===\n";
                                    settingsTxt += `全局主题: ${db.globalTheme || 'default'}\n`;
                                    settingsTxt += `壁纸URL: ${db.wallpaper || 'default'}\n`;
                                    settingsTxt += `API地址: ${db.apiSettings?.url || ''}\n`;
                                    settingsTxt += `API模型: ${db.apiSettings?.model || ''}\n`;
            
                                    zip.file("世界书与设定.txt", settingsTxt);
            
                                    // 生成 ZIP
                                    const content = await zip.generateAsync({type:"blob"});
                                    
                                    // 下载
                                    const url = URL.createObjectURL(content);
                                    const now = new Date();
                                    const dateStr = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `章鱼机_备份_${dateStr}.zip`;
                                    a.style.display = 'none';
                                    document.body.appendChild(a);
                                    a.click();
                                    
                                    setTimeout(() => {
                                        document.body.removeChild(a);
                                        URL.revokeObjectURL(url);
                                        loadingBtn = false;
                                        showToast('导出成功！');
                                    }, 1500);
            
                                } catch (e) {
                                    loadingBtn = false;
                                    console.error(e);
                                    showToast(`导出失败: ${e.message}`);
                                }
                            });
            
                            // --- 导入 (还原) 按钮 ---
                            // 创建一个隐藏的 file input，支持 multiple
                            const importInput = document.createElement('input');
                            importInput.type = 'file';
                            importInput.accept = '.txt';
                            importInput.multiple = true; // 允许选择多个文件
                            importInput.style.display = 'none';
            
                            const importLabel = document.createElement('label');
                            importLabel.className = 'btn btn-neutral';
                            importLabel.textContent = '导入对话 (选择多个txt)';
                            importLabel.style.marginTop = '15px';
                            importLabel.style.display = 'block';
                            importLabel.style.textAlign = 'center';
                            
                            // 绑定点击事件触发 input
                            importLabel.addEventListener('click', () => {
                                importInput.click();
                            });
            
                            importInput.addEventListener('change', async (e) => {
                                const files = e.target.files;
                                if (!files || files.length === 0) return;
            
                                showToast(`正在处理 ${files.length} 个文件...`);
                                let successCount = 0;
                                let failCount = 0;
            
                                for (let i = 0; i < files.length; i++) {
                                    const file = files[i];
                                    // 跳过设定文件
                                    if (file.name.includes("世界书与设定")) {
                                        continue; 
                                    }
            
                                    // 获取文件名作为角色名 (去掉 .txt)
                                    const charName = file.name.replace(/\.txt$/i, '');
                                    
                                    // 查找已有角色
                                    const targetChar = db.characters.find(c => c.remarkName === charName);
            
                                    if (!targetChar) {
                                        alert(`跳过导入：找不到名为“${charName}”的角色。\n请先在首页创建一个备注名为“${charName}”的角色(不需要设置头像，创建即可)。`);
                                        failCount++;
                                        continue;
                                    }
            
                                    try {
                                        const text = await file.text();
                                        const lines = text.split('\n');
                                        const newHistory = [];
            
                                        // 正则解析: [时间] (角色): 内容
                                        // 例子: [2024-11-27 12:12:12] (User): 你好
                                        const regex = /^\[(.*?)\] \((.*?)\): (.*)$/;
            
                                        lines.forEach(line => {
                                            if (!line.trim()) return;
                                            const match = line.match(regex);
                                            if (match) {
                                                const timeStr = match[1];
                                                const roleName = match[2];
                                                let content = match[3];
                                                
                                                // 还原换行符
                                                content = content.replace(/\\n/g, '\n');
            
                                                // 判断是谁发的
                                                // 如果名字等于角色名 -> assistant
                                                // 否则 -> user
                                                const role = (roleName === targetChar.remarkName) ? 'assistant' : 'user';
            
                                                newHistory.push({
                                                    id: `msg_imp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
                                                    role: role,
                                                    content: content,
                                                    parts: [{ type: 'text', text: content }], // 简化的 parts
                                                    timestamp: new Date(timeStr).getTime() || Date.now()
                                                });
                                            }
                                        });
            
                                        if (newHistory.length > 0) {
                                            // 将新导入的记录追加到现有记录后面 (或者你可以选择覆盖)
                                            // 这里选择：如果现有记录为空，直接赋值；如果有记录，追加在后面
                                            const existingHistory = await dataStorage.getHistory(targetChar.id) || [];
                                            targetChar.history = existingHistory.concat(newHistory);
                                            // 按时间排序，防止乱序
                                            targetChar.history.sort((a, b) => a.timestamp - b.timestamp);
                                            
                                            await saveData(); // 保存到 IndexedDB
                                            successCount++;
                                        }
            
                                    } catch (err) {
                                        console.error(err);
                                        failCount++;
                                    }
                                }
            
                                // 清空 input 以便下次选择相同文件
                                importInput.value = ''; 
                                
                                let msg = `导入完成。\n成功: ${successCount} 个\n失败/跳过: ${failCount} 个`;
                                if (successCount > 0) msg += "\n请返回聊天列表查看。";
                                alert(msg);
                                
                                // 如果当前在聊天界面，刷新一下
                                if (currentChatId) {
                                    renderMessages(false, true);
                                }
                            });
            
                            tutorialContentArea.appendChild(backupDataBtn);
                            tutorialContentArea.appendChild(importLabel);
                            // 别忘了把 input 也加到 DOM 里，不然不会触发
                            tutorialContentArea.appendChild(importInput); 
            
                            // --- 后面是原本的主题切换代码，保持不变 ---
                            const themeContainer = document.createElement('div');
                            themeContainer.style.marginTop = '20px';
                            themeContainer.style.padding = '15px';
                            themeContainer.style.border = '2px solid var(--primary-color)';
                            themeContainer.style.borderRadius = '12px';
                            themeContainer.style.backgroundColor = 'rgba(255,255,255,0.8)';
            
                            const themeLabel = document.createElement('label');
                            themeLabel.textContent = '🎨 切换全局主题：';
                            themeLabel.style.fontWeight = 'bold';
                            themeLabel.style.color = 'var(--primary-color)';
                            themeLabel.style.display = 'block';
                            themeLabel.style.marginBottom = '10px';
            
                            const themeSelect = document.createElement('select');
                            themeSelect.style.width = '100%';
                            themeSelect.style.padding = '8px';
                            themeSelect.style.borderRadius = '8px';
                            themeSelect.style.border = '1px solid var(--primary-color)';
                            themeSelect.style.color = 'var(--primary-color)';
                            themeSelect.style.fontSize = '16px';
            
                            for (const [key, value] of Object.entries(APP_THEMES)) {
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = value.name;
                                if ((db.globalTheme || 'pink_cat') === key) option.selected = true;
                                themeSelect.appendChild(option);
                            }
            
                            themeSelect.addEventListener('change', (e) => {
                                applyGlobalTheme(e.target.value);
                                showToast(`已切换至：${APP_THEMES[e.target.value].name}`);
                            });
            
                            themeContainer.appendChild(themeLabel);
                            themeContainer.appendChild(themeSelect);
                            tutorialContentArea.appendChild(themeContainer);
                        }

            function setupChatListScreen() {
                renderChatList();
                addChatBtn.addEventListener('click', () => {
                    addCharModal.classList.add('visible');
                    addCharForm.reset();
                });
                chatListContainer.addEventListener('click', (e) => {
                    const chatItem = e.target.closest('.chat-item');
                    if (chatItem) {
                        currentChatId = chatItem.dataset.id;
                        openChatRoom(currentChatId);
                    }
                });
                chatListContainer.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const chatItem = e.target.closest('.chat-item');
                    if (!chatItem) return;
                    handleChatListLongPress(chatItem.dataset.id, e.clientX, e.clientY);
                });
                chatListContainer.addEventListener('touchstart', (e) => {
                    const chatItem = e.target.closest('.chat-item');
                    if (!chatItem) return;
                    longPressTimer = setTimeout(() => {
                        const touch = e.touches[0];
                        handleChatListLongPress(chatItem.dataset.id, touch.clientX, touch.clientY);
                    }, 400);
                });
                chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
                chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            }

            function handleChatListLongPress(chatId, x, y) {
                clearTimeout(longPressTimer);
                const chatItem = db.characters.find(c => c.id === chatId);
                if (!chatItem) return;
                const menuItems = [{
                    label: chatItem.isPinned ? '取消置顶' : '置顶聊天',
                    action: async () => {
                        chatItem.isPinned = !chatItem.isPinned;
                        await saveData();
                        renderChatList();
                    }
                }, {
                    label: '删除聊天',
                    danger: true,
                    action: async () => {
                        if (confirm(`确定要删除与“${chatItem.remarkName}”的聊天记录吗？此操作不可恢复。`)) {
                            db.characters = db.characters.filter(c => c.id !== chatId);
                            await saveData();
                            renderChatList();
                            showToast('聊天已删除');
                        }
                    }
                }];
                createContextMenu(menuItems, x, y);
            }

            function renderChatList() {
                chatListContainer.innerHTML = '';
                const allChats = db.characters;

                noChatsPlaceholder.style.display = allChats.length === 0 ? 'block' : 'none';

                const sortedChats = allChats.sort((a, b) => {
                    if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                    return 0;
                });

                const hearts = ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎'];

                sortedChats.forEach(chat => {
                    const randomHeart = hearts[Math.floor(Math.random() * hearts.length)];
                    const previewText = `${randomHeart} [在线]`;

                    const li = document.createElement('li');
                    li.className = 'list-item chat-item';
                    if (chat.isPinned) li.classList.add('pinned');
                    li.dataset.id = chat.id;

                    const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';

                    li.innerHTML = `
                <img src="${chat.avatar}" alt="${chat.remarkName}" class="chat-avatar">
                <div class="item-details">
                    <div class="item-details-row"><div class="item-name">${chat.remarkName}</div></div>
                    <div class="item-preview-wrapper">
                        <div class="item-preview" style="color: #888; font-size: 13px;">${previewText}</div>
                        ${pinBadgeHTML}
                    </div>
                </div>`;
                    chatListContainer.appendChild(li);
                });
            }
            function setupAddCharModal() {
                addCharForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newChar = {
                        id: `char_${Date.now()}`,
                        realName: document.getElementById('char-real-name').value,
                        remarkName: document.getElementById('char-remark-name').value,
                        persona: '',
                        avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                        myName: document.getElementById('my-name-for-char').value,
                        myPersona: '',
                        myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                        theme: 'white_pink',
                        maxMemory: 10,
                        chatBg: '',
                        history: [],
                        isPinned: false,
                        status: '在线',
                        worldBookIds: [],
                        useCustomBubbleCss: false,
                        customBubbleCss: '',
                        enableAutoSummary: false,
                        summaryTurnInterval: 20,
                        longTermMemory: ''
                    };
                    db.characters.push(newChar);
                    await saveData();
                    renderChatList();
                    addCharModal.classList.remove('visible');
                    showToast(`角色“${newChar.remarkName}”创建成功！`);
                });
            }

            function setupChatRoom() {
                sendMessageBtn.addEventListener('click', sendMessage);
                sendMessageBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    sendMessage();
                    setTimeout(() => {
                        messageInput.focus();
                    }, 50);
                });
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !isGenerating) sendMessage();
                });
                getReplyBtn.addEventListener('click', getAiReply);
                messageArea.addEventListener('click', (e) => {
                    if (stickerModal.classList.contains('visible')) {
                        stickerModal.classList.remove('visible');
                        return;
                    }

                    if (e.target && e.target.id === 'load-more-btn') {
                        loadMoreMessages();
                    } else if (isInMultiSelectMode) {
                        const messageWrapper = e.target.closest('.message-wrapper');
                        if (messageWrapper) {
                            toggleMessageSelection(messageWrapper.dataset.id);
                        }
                    } else {
                        const pvCard = e.target.closest('.pv-card');
                        if (pvCard) {
                            const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                            const footer = pvCard.querySelector('.pv-card-footer');
                            imageOverlay.classList.toggle('hidden');
                            footer.classList.toggle('hidden');
                        }

                    }
                });
                messageArea.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (!messageWrapper) return;
                    handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
                });
                messageArea.addEventListener('touchstart', (e) => {
                    if (e.target.id === 'load-more-btn') return;
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (!messageWrapper) return;
                    longPressTimer = setTimeout(() => {
                        const touch = e.touches[0];
                        handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
                    }, 400);
                });
                messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
                messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                saveEditBtn.addEventListener('click', saveMessageEdit);
                cancelEditBtn.addEventListener('click', cancelMessageEdit);
                cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
                deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);
            }
			
			// --- 图片查看器逻辑 ---
			            const imageViewerModal = document.getElementById('image-viewer-modal');
			            const imageViewerImg = document.getElementById('image-viewer-img');
			
			            // 点击查看器任意位置（背景或图片）都关闭
			            imageViewerModal.addEventListener('click', () => {
			                imageViewerModal.classList.remove('visible');
			                setTimeout(() => {
			                    imageViewerImg.src = ''; // 关闭后清空图片，节省内存
			                }, 300);
			            });
			
			            function openImageViewer(src) {
			                imageViewerImg.src = src;
			                imageViewerModal.classList.add('visible');
			            }

            function handleMessageLongPress(messageWrapper, x, y) {
                if (isInMultiSelectMode) return;
                clearTimeout(longPressTimer);
                const messageId = messageWrapper.dataset.id;
                const chat = db.characters.find(c => c.id === currentChatId);
                const message = chat.history.find(m => m.id === messageId);
                if (!message) return;

                const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');
                const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);
                const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);
                const isInvisibleMessage = /\[.*?更新状态为：.*?\]|\[system:.*?\]|\[system-display:.*?\]/.test(message.content);

                let menuItems = [];
                  if (!isStickerMessage && !isPhotoVideoMessage && !isInvisibleMessage) {
                                    menuItems.push({ label: '编辑', action: () => startMessageEdit(messageId) });
                                }
                                
                                menuItems.push({ label: '删除', action: () => enterMultiSelectMode(messageId) });
                
                                if (menuItems.length > 0) {
                                    createContextMenu(menuItems, x, y);
                                }
                            }

            function startMessageEdit(messageId) {
                exitMultiSelectMode();
                editingMessageId = messageId;
                const chat = db.characters.find(c => c.id === currentChatId);
                const message = chat.history.find(m => m.id === messageId);
                if (!message) return;
                const match = message.content.match(/\[.*?的消息：([\s\S]+)\]/);
                const contentToEdit = match ? match[1].trim() : message.content;
                messageEditInput.value = contentToEdit;
                messageInputDefault.style.display = 'none';
                messageEditBar.style.display = 'flex';
                messageEditInput.focus();
            }

            async function saveMessageEdit() {
                            const chat = db.characters.find(c => c.id === currentChatId);
                            const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
                            if (messageIndex === -1) return;
                            
                            const newText = messageEditInput.value.trim();
                            if (newText) {
                                const oldContent = chat.history[messageIndex].content;
                                
                                // 检查原消息是否是标准的对话格式 [xxx的消息：内容]
                                const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/);
                                
                                let newContent;
                                if (prefixMatch) {
                                    // 如果原消息有包裹，则保留包裹，只替换内容
                                    const prefix = prefixMatch[1];
                                    newContent = `${prefix}${newText}]`;
                                } else {
                                    // 如果原消息没有包裹（比如是图片Base64、URL、或者系统提示），则原样保存输入的内容
                                    newContent = newText;
                                }
            
                                chat.history[messageIndex].content = newContent;
                                
                                // 更新 parts，确保 API 发送时也能同步更新
                                // 如果是图片链接，这里作为 text 发送给 AI，AI 能看到链接
                                chat.history[messageIndex].parts = [{ type: 'text', text: newContent }];
                                
                                await saveData();
                                currentPage = 1; // 重置页码
                                renderMessages(false, true); // 重新渲染消息列表
                                renderChatList(); // 更新左侧列表预览
                            }
                            cancelMessageEdit();
                        }

            function cancelMessageEdit() {
                editingMessageId = null;
                messageInputDefault.style.display = 'flex';
                messageEditBar.style.display = 'none';
            }

            function enterMultiSelectMode(initialMessageId) {
                isInMultiSelectMode = true;
                chatRoomHeaderDefault.style.display = 'none';
                chatRoomHeaderSelect.style.display = 'flex';
                document.querySelector('.chat-input-wrapper').style.display = 'none';
                multiSelectBar.classList.add('visible');
                chatRoomScreen.classList.add('multi-select-active');
                selectedMessageIds.clear();
                if (initialMessageId) {
                    toggleMessageSelection(initialMessageId);
                }
            }

            function exitMultiSelectMode() {
                isInMultiSelectMode = false;
                chatRoomHeaderDefault.style.display = 'flex';
                chatRoomHeaderSelect.style.display = 'none';
                document.querySelector('.chat-input-wrapper').style.display = 'block';
                multiSelectBar.classList.remove('visible');
                chatRoomScreen.classList.remove('multi-select-active');
                selectedMessageIds.forEach(id => {
                    const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);
                    if (el) el.classList.remove('multi-select-selected');
                });
                selectedMessageIds.clear();
            }

            function toggleMessageSelection(messageId) {
                const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
                if (!el) return;
                if (selectedMessageIds.has(messageId)) {
                    selectedMessageIds.delete(messageId);
                    el.classList.remove('multi-select-selected');
                } else {
                    selectedMessageIds.add(messageId);
                    el.classList.add('multi-select-selected');
                }
                selectCount.textContent = `已选择 ${selectedMessageIds.size} 项`;
                deleteSelectedBtn.disabled = selectedMessageIds.size === 0;
            }

            async function deleteSelectedMessages() {
                if (selectedMessageIds.size === 0) return;
                const deletedCount = selectedMessageIds.size;
                const chat = db.characters.find(c => c.id === currentChatId);
                chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
                await saveData();
                currentPage = 1;
                renderMessages(false, true);
                renderChatList();
                exitMultiSelectMode();
                showToast(`已删除 ${deletedCount} 条消息`);
            }

            let currentVisibleCount = 10;

            async function openChatRoom(chatId) {
                const chat = db.characters.find(c => c.id === chatId);
                if (!chat) return;

                switchScreen('chat-room-screen');
                messageArea.innerHTML = '<div style="padding:50px; text-align:center; color:#ccc; font-size:14px;">正在读取记忆...</div>';
                await new Promise(r => setTimeout(r, 50));

                const fullHistory = await dataStorage.getHistory(chatId);
                chat.history = fullHistory || [];
                currentVisibleCount = 10;

                exitMultiSelectMode();
                cancelMessageEdit();

                chatRoomTitle.textContent = chat.remarkName;
                const subtitle = document.getElementById('chat-room-subtitle');
                subtitle.style.display = 'flex';
                chatRoomStatusText.textContent = chat.status || '在线';

                getReplyBtn.style.display = 'inline-flex';
                chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : '';
                chatRoomScreen.setAttribute('data-theme', chat.theme || 'white_pink');

                typingIndicator.style.display = 'none';
                isGenerating = false;
                getReplyBtn.disabled = false;

                chatRoomScreen.className = chatRoomScreen.className.replace(/\bchat-active-[^ ]+\b/g, '');
                chatRoomScreen.classList.add(`chat-active-${chatId}`);
                updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);

                renderMessages(false, true);
            }

            function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
                const chat = db.characters.find(c => c.id === currentChatId);
                if (!chat || !chat.history) return;

                const totalMessages = chat.history.length;
                const start = Math.max(0, totalMessages - currentVisibleCount);
                const messagesToRender = chat.history.slice(start, totalMessages);

                if (!isLoadMore) messageArea.innerHTML = '';

                const fragment = document.createDocumentFragment();
                messagesToRender.forEach(msg => {
                    const bubble = createMessageBubbleElement(msg);
                    if (bubble) fragment.appendChild(bubble);
                });

                const existingLoadBtn = document.getElementById('load-more-btn');
                if (existingLoadBtn) existingLoadBtn.remove();

                if (!isLoadMore) {
                    messageArea.appendChild(fragment);
                } else {
                    messageArea.innerHTML = '';
                    messageArea.appendChild(fragment);
                }

                if (start > 0) {
                    const loadMoreButton = document.createElement('button');
                    loadMoreButton.id = 'load-more-btn';
                    loadMoreButton.className = 'load-more-btn';
                    loadMoreButton.textContent = '加载更早的消息';
                    loadMoreButton.onclick = () => {
                        currentVisibleCount += 20;
                        renderMessages(true, false);
                    };
                    messageArea.prepend(loadMoreButton);
                }

                if (forceScrollToBottom) {
                    setTimeout(() => {
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }, 0);
                }
            }


            function createMessageBubbleElement(message) {
                            const chat = db.characters.find(c => c.id === currentChatId);
                            const { role, content, timestamp, id, stickerData } = message;
            
                            // 1. 过滤隐藏消息
                            const invisibleRegex = /\[.*?更新状态为：.*?\]|\[system:.*?\]/;
                            if (invisibleRegex.test(content)) {
                                return null; // 不渲染
                            }
            
                            // 2. 处理时间跳过/系统显示消息
                            const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                            const timeSkipMatch = content.match(timeSkipRegex);
                            
                            const wrapper = document.createElement('div');
                            wrapper.dataset.id = id;
            
                            if (timeSkipMatch) {
                                wrapper.className = 'message-wrapper system-notification';
                                wrapper.innerHTML = `<div class="system-notification-bubble">${timeSkipMatch[1]}</div>`;
                                return wrapper;
                            }
            
                            // 3. 准备基本变量
                            const isSent = (role === 'user');
                            let avatarUrl, bubbleTheme;
                            const themeKey = chat.theme || 'white_pink';
                            const theme = colorThemes[themeKey] || colorThemes['white_pink'];
            
                            if (isSent) {
                                avatarUrl = chat.myAvatar;
                                bubbleTheme = theme.sent;
                            } else {
                                avatarUrl = chat.avatar;
                                bubbleTheme = theme.received;
                            }
                            const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
                            
                            // 4. 正则匹配
                            const sentStickerRegex = /\[(?:.+?)的表情包：.+?\]/i;
                            const receivedStickerRegex = /\[(?:.+?)发送的表情包：([\s\S]+?)\]/i;
                            const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
                            const textRegex = /\[(?:.+?)的消息：([\s\S]+?)\]/;
            
                            const sentStickerMatch = content.match(sentStickerRegex);
                            const receivedStickerMatch = content.match(receivedStickerRegex);
                            const photoVideoMatch = content.match(photoVideoRegex);
                            const textMatch = content.match(textRegex);
            
                            // --- 核心修改：提取并判断是否为纯图片 ---
                            
                            // 获取“真实内容”：如果被[xx的消息：]包裹，取里面的；否则取原内容
                            let actualContent = content.trim();
                            if (textMatch) {
                                actualContent = textMatch[1].trim();
                            }
            
                            // 判断逻辑：
                            // A. 是 Base64 数据
                            const isBase64 = actualContent.startsWith('data:image');
                            // B. 是图片链接 (http开头 或 meme/开头，且以图片后缀结尾)
                            const isImageUrl = /(^https?:\/\/|^meme\/).+\.(jpeg|jpg|gif|png|webp|bmp)(\?.*)?$/i.test(actualContent);
            
                            wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
                            const bubbleRow = document.createElement('div');
                            bubbleRow.className = 'message-bubble-row';
                            let bubbleElement;
            
                            // --- 优先级 1：图片渲染 (无文字气泡背景) ---
                            if (isBase64 || isImageUrl) {
                                bubbleElement = document.createElement('div');
                                // 使用 image-bubble 类，自带半透明背景和圆角，像表情包一样
                                bubbleElement.className = 'image-bubble'; 
                                // 只有图片，没有包裹的文字气泡
                                bubbleElement.innerHTML = `<img src="${actualContent}" alt="图片" style="display:block; max-width:100%;">`;
                                
                                // 点击放大预览
                                                    bubbleElement.onclick = (e) => {
                                                        e.stopPropagation(); // 防止触发长按或多选
                                                        openImageViewer(actualContent); // 调用刚才写的函数在App内打开
                                                    };
                            }
                            // --- 优先级 2：表情包 ---
                            else if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
                                bubbleElement = document.createElement('div');
                                bubbleElement.className = 'image-bubble';
                                let stickerSrc = '';
                                if (isSent) {
                                    stickerSrc = stickerData;
                                } else {
                                    const rawPath = receivedStickerMatch[1].trim();
                                    const finalPath = rawPath.split('/').pop();
                                    stickerSrc = `meme/${finalPath}`;
                                }
                                bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="表情包">`;
                            }
                            // --- 优先级 3：照片/视频卡片 ---
                            else if (photoVideoMatch) {
                               bubbleElement = document.createElement('div');
                               bubbleElement.className = 'pv-card';
                               bubbleElement.innerHTML = `<div class="pv-card-content">${photoVideoMatch[1].trim()}</div><div class="pv-card-image-overlay" style="background-image: url('image/背景.jpg');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
                            }
                            // --- 优先级 4：普通文本 (只有这里才套颜色气泡) ---
                            else {
                                bubbleElement = document.createElement('div');
                                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                                
                                // 如果有 html 格式 parts
                                if (message && Array.isArray(message.parts) && message.parts[0].type === 'html') {
                                     bubbleElement.innerHTML = message.parts[0].text;
                                } else {
                                     // 如果是 textMatch 匹配到的内容，或者纯 content
                                     bubbleElement.textContent = textMatch ? textMatch[1].trim() : content;
                                }
            
                                if (!chat.useCustomBubbleCss) {
                                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                                    bubbleElement.style.color = bubbleTheme.text;
                                }
                            }
            
                            bubbleRow.innerHTML = `<div class="message-info"><img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
                            if (bubbleElement) {
                                bubbleRow.appendChild(bubbleElement);
                            }
                            wrapper.prepend(bubbleRow);
                            return wrapper;
                        }


            async function addMessageBubble(message) {
                const character = db.characters.find(c => c.id === currentChatId);
                const updateStatusRegex = new RegExp(`\\[${character.realName}更新状态为：(.*?)\\]`);
                if (message.content.match(updateStatusRegex)) {
                    character.status = message.content.match(updateStatusRegex)[1];
                    chatRoomStatusText.textContent = character.status;
                    await saveData();
                    return;
                }
                {
                    const bubbleElement = createMessageBubbleElement(message);
                    if (bubbleElement) {
                        messageArea.appendChild(bubbleElement);
                        messageArea.scrollTo({ top: messageArea.scrollHeight, behavior: 'smooth' });
                    }
                }
            }

            async function sendMessage() {
                const text = messageInput.value.trim();
                if (!text || isGenerating) return;
                const chat = db.characters.find(c => c.id === currentChatId);
                let messageContent;
                const systemRegex = /\[system:.*?\]|\[system-display:.*?\]/;
                const myName = chat.myName;

                if (systemRegex.test(text)) {
                    messageContent = text;
                } else {
                    messageContent = `[${myName}的消息：${text}]`;
                }
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: messageContent,
                    parts: [{ type: 'text', text: messageContent }],
                    timestamp: Date.now()
                };
                chat.history.push(message);
                addMessageBubble(message);
                await saveData();
                renderChatList();
                messageInput.value = '';
            }

            async function sendImageForRecognition(base64Data) {
                if (!base64Data || isGenerating) return;
                const chat = db.characters.find(c => c.id === currentChatId);
                const myName = chat.myName;
                const textPrompt = `[${myName}发来了一张图片：]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: base64Data,
                    parts: [{ type: 'text', text: textPrompt }, { type: 'image', data: base64Data }],
                    timestamp: Date.now(),
                };
                chat.history.push(message);
                addMessageBubble(message);
                await saveData();
                renderChatList();
            }

            async function sendSticker(sticker) {
                const chat = db.characters.find(c => c.id === currentChatId);
                const myName = chat.myName;
                const messageContentForAI = `[${myName}的表情包：${sticker.name}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: messageContentForAI,
                    parts: [{ type: 'text', text: messageContentForAI }],
                    timestamp: Date.now(),
                    stickerData: sticker.data
                };
                chat.history.push(message);
                addMessageBubble(message);
                await saveData();
                renderChatList();
                stickerModal.classList.remove('visible');
            }


            async function sendMyPhotoVideo(text) {
                if (!text) return;
                const chat = db.characters.find(c => c.id === currentChatId);
                const myName = chat.myName;
                const content = `[${myName}发来的照片\/视频：${text}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{ type: 'text', text: content }],
                    timestamp: Date.now()
                };
                chat.history.push(message);
                addMessageBubble(message);
                await saveData();
                renderChatList();
                sendPvModal.classList.remove('visible');
            }

            function setupTimeSkipSystem() {
                const btn = document.getElementById('time-skip-btn');
                const modal = document.getElementById('time-skip-modal');
                const form = document.getElementById('time-skip-form');
                const input = document.getElementById('time-skip-input');
                const historyBtn = document.getElementById('ts-history-btn');
                const formView = document.getElementById('ts-form-view');
                const historyView = document.getElementById('ts-history-view');
                const historyList = document.getElementById('ts-history-list');
                const backBtn = document.getElementById('ts-history-back-btn');

                btn.addEventListener('click', () => {
                    form.reset();
                    formView.style.display = 'block';
                    historyView.style.display = 'none';
                    historyBtn.style.display = 'block';
                    modal.classList.add('visible');
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('visible');
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    sendTimeSkipMessage(input.value.trim());
                });

                historyBtn.addEventListener('click', () => {
                    renderTodayHistory();
                    formView.style.display = 'none';
                    historyBtn.style.display = 'none';
                    historyView.style.display = 'flex';
                });

                backBtn.addEventListener('click', () => {
                    formView.style.display = 'block';
                    historyBtn.style.display = 'block';
                    historyView.style.display = 'none';
                });

                function renderTodayHistory() {
                    historyList.innerHTML = '';

                    const chat = db.characters.find(c => c.id === currentChatId);
                    if (!chat || !chat.history) return;

                    const now = new Date();
                    const todayStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;

                    const records = chat.history.filter(m => {
                        const mDate = new Date(m.timestamp);
                        const mDateStr = `${mDate.getFullYear()}-${mDate.getMonth() + 1}-${mDate.getDate()}`;
                        return m.content.includes('[system-display:') && mDateStr === todayStr;
                    });

                    if (records.length === 0) {
                        historyList.innerHTML = '<li style="text-align:center; color:#ccc; padding:20px;">今天还没有记录哦</li>';
                        return;
                    }

                    records.reverse().forEach(msg => {
                        const li = document.createElement('li');
                        li.className = 'ts-history-item';

                        const match = msg.content.match(/\[system-display:([\s\S]+?)\]/);
                        const contentText = match ? match[1] : msg.content;

                        const timeObj = new Date(msg.timestamp);
                        const timeStr = `${pad(timeObj.getHours())}:${pad(timeObj.getMinutes())}`;

                        li.innerHTML = `
                                <div class="ts-history-time">${timeStr}</div>
                                <div>${contentText}</div>
                            `;

                        let pressTimer;
                        li.addEventListener('touchstart', (e) => {
                            pressTimer = setTimeout(() => {
                                confirmDeleteRecord(chat, msg);
                            }, 600);
                        });
                        li.addEventListener('touchend', () => clearTimeout(pressTimer));
                        li.addEventListener('touchmove', () => clearTimeout(pressTimer));
                        li.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            confirmDeleteRecord(chat, msg);
                        });

                        historyList.appendChild(li);
                    });
                }

                async function confirmDeleteRecord(chat, visualMsg) {
                    if (confirm('确定要删除这条记录吗？\n(相关的AI记忆也会一并删除)')) {
                        chat.history = chat.history.filter(m => m.id !== visualMsg.id);

                        const match = visualMsg.content.match(/\[system-display:([\s\S]+?)\]/);
                        if (match) {
                            const contentCore = match[1];
                            const contextPattern = `[system: ${contentCore}]`;

                            const contextMsgIndex = chat.history.findIndex(m =>
                                m.content.includes(contextPattern) && Math.abs(m.timestamp - visualMsg.timestamp) < 2000
                            );

                            if (contextMsgIndex !== -1) {
                                chat.history.splice(contextMsgIndex, 1);
                            }
                        }

                        await saveData();
                        renderTodayHistory();
                        renderMessages(false, true);
                        showToast('记录已删除');
                    }
                }
            }

            async function sendTimeSkipMessage(text) {
                if (!text) return;
                const chat = db.characters.find(c => c.id === currentChatId);
                if (!chat) return;

                const visualMessage = {
                    id: `msg_visual_${Date.now()}`,
                    role: 'system',
                    content: `[system-display:${text}]`,
                    parts: [],
                    timestamp: Date.now()
                };
                const contextMessage = {
                    id: `msg_context_${Date.now()}`,
                    role: 'user',
                    content: `[system: ${text}]`,
                    parts: [{ type: 'text', text: `[system: ${text}]` }],
                    timestamp: Date.now()
                };

                chat.history.push(visualMessage, contextMessage);
                addMessageBubble(visualMessage);
                await saveData();
                renderChatList();
                timeSkipModal.classList.remove('visible');
            }

            function getMixedContent(responseData) {
                const results = [];
                const regex = /<orange(?:\s+char="([^"]*)")?>([\s\S]*?)<\/orange>|(\[.*?\])/g;

                let match;
                while ((match = regex.exec(responseData)) !== null) {
                    if (match[1] !== undefined || match[2] !== undefined) {
                        results.push({
                            type: 'html',
                            char: match[1] || null,
                            content: match[2].trim()
                        });
                    }
                    else if (match[3]) {
                        results.push({
                            type: 'text',
                            content: match[3]
                        });
                    }
                }
                return results;
            }

            function generatePrivateSystemPrompt(character) {
                const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
                const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
                const now = new Date();
                const currentTime = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}:${pad(now.getMinutes())}`;
                let prompt = `你正在一个名为“404”的线上聊天软件中与我连接。以下是我希望你遵守的规定：\n`;
                prompt += `核心规则：\n`;
                prompt += `A. 当前时间：现在是 ${currentTime}。你应知晓当前时间，但除非对话内容明确相关，否则不要主动提及或评论时间（例如，不要频繁催促我睡觉）。\n`;
                prompt += `B. 纯线上互动：这是一个线上聊天。\n\n`;

                if (character.summaryHistory && character.summaryHistory.length > 0) {
                    let memoryBlock = "长期记忆摘要 (按时间顺序排列):\n";
                    character.summaryHistory.forEach(item => {
                        memoryBlock += `${item.timestamp}\n${item.content}\n\n`;
                    });
                    prompt += `${memoryBlock}----------------\n\n`;
                }

                prompt += `角色对话规则：\n`;
                if (worldBooksBefore) {
                    prompt += `${worldBooksBefore}\n`;
                }
                prompt += `1. 你是：${character.realName}。我是：${character.myName}。你的当前状态是：${character.status}。\n`;
                prompt += `2. 你的身份是：${character.persona}\n如果此处内容为空，则表示我希望你做自己。`;
                if (worldBooksAfter) {
                    prompt += `${worldBooksAfter}\n`;
                }
                if (character.myPersona) {
                    prompt += `3. 关于我：${character.myPersona}\n`;
                }
                prompt += `4. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
    - [${character.myName}的表情包：xxx]：我给你发送了一个名为xxx的表情包。你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。
    - [${character.myName}发来了一张图片：]：我给你发送了一张图片，你需要对图片内容做出回应。
    - [${character.myName}发来的照片/视频：xxx]：我给你分享了一个描述为xxx的照片或视频。
    - [system: xxx]：这是一条系统指令，用于设定场景或提供上下文，此条信息不应在对话中被直接提及，你只需理解其内容并应用到后续对话中。
5. ✨重要✨ 你可以随时更新你的在线状态，以反映你当前的行为或心情。这会让互动更真实。格式为：[${character.realName}更新状态为：xxx]。例如：[${character.realName}更新状态为：正在等你...]。这条指令不会显示为聊天消息，只会更新你在我界面上的状态。
6. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)、*环境描写*等多余的、在括号或星号里的叙述性文本。
`;
                prompt += `7. 你拥有发送表情包的能力。这是一个可选功能，你可以根据对话氛围和内容，自行判断是否需要发送表情包来辅助表达。你不必在每次回复中都包含表情包。格式为：[${character.realName}发送的表情包：图片URL]。\n`;
                prompt += `8. 你的输出格式必须严格遵循以下几种之一，可以组合使用：
    a) 普通消息: [${character.realName}的消息：{消息内容}]
    b) 表情包/图片: [${character.realName}发送的表情包：{表情包路径}]。注意：这里的路径不需要包含"meme/"，只需要提供后面的部分，例如 "害羞.jpg"。
	c) 更新状态(此条不显示): [${character.realName}更新状态为：{新状态}]`;
                prompt += `9. 你的每次回复可以生成3到8条消息。这些消息应以普通文本消息为主，可以偶尔、选择性地穿插一条特殊消息（表情包等），特殊消息的位置应随机。大部分回复应该只包含文本消息。\n`;
                prompt += `10. 不要主动结束对话，除非我明确提出。保持你的人设，自然地进行对话。`;
                return prompt;
            }

            async function getAiReply() {
                if (isGenerating) return;
                const chat = db.characters.find(c => c.id === currentChatId);
                if (!chat) return;

                await checkForAutoSummary(chat);

                const { url, key, model, provider, temperature } = db.apiSettings;
                const aiTemp = temperature !== undefined ? temperature : 1.0;
                if (!url || !key || !model) {
                    showToast('请先在“api”应用中完成设置！');
                    switchScreen('api-settings-screen');
                    return;
                }

                isGenerating = true;
                getReplyBtn.disabled = true;
                const typingName = chat.remarkName;
                typingIndicator.textContent = `“${typingName}”正在输入中...`;
                typingIndicator.style.display = 'block';
                messageArea.scrollTop = messageArea.scrollHeight;
                try {
                    let systemPrompt, requestBody;
                    systemPrompt = generatePrivateSystemPrompt(chat);

                    const historySlice = chat.history.slice(-chat.maxMemory);
                    if (provider === 'gemini') {
                        const contents = historySlice.map(msg => {
                            const role = msg.role === 'assistant' ? 'model' : 'user';
                            let parts;
                            if (msg.parts && msg.parts.length > 0) {
                                parts = msg.parts.map(p => {
                                    if (p.type === 'text' || p.type === 'html') {
                                        return { text: p.text };
                                    } else if (p.type === 'image') {
                                        const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                                        if (match) {
                                            return { inline_data: { mime_type: match[1], data: match[3] } };
                                        }
                                    }
                                    return null;
                                }).filter(p => p);
                            } else {
                                parts = [{ text: msg.content }];
                            }
                            return { role, parts };
                        });
                        requestBody = {
                            contents: contents,
                            system_instruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: {
                                temperature: aiTemp
                            }
                        };
                    } else {
                        const messages = [{ role: 'system', content: systemPrompt }];
                        historySlice.forEach(msg => {
                            let content;
                            if (msg.parts && msg.parts.length > 0) {
                                content = msg.parts.map(p => {
                                    if (p.type === 'text' || p.type === 'html') {
                                        return { type: 'text', text: p.text };
                                    } else if (p.type === 'image') {
                                        return { type: 'image_url', image_url: { url: p.data } };
                                    }
                                    return null;
                                }).filter(p => p);
                            } else {
                                content = msg.content;
                            }
                            messages.push({ role: msg.role, content: content });
                        });
                        requestBody = {
                            model: model,
                            messages: messages,
                            stream: true,
                            temperature: aiTemp
                        };
                    }
                    const endpoint = (provider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
                    const headers = (provider === 'gemini') ? { 'Content-Type': 'application/json' } : {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${key}`
                    };
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    await processStream(response, chat, provider);
                } catch (error) {
                    console.error('AI回复失败:', error);
                    showToast(`AI回复失败: ${error.message}`);
                } finally {
                    isGenerating = false;
                    getReplyBtn.disabled = false;
                    typingIndicator.style.display = 'none';
                }
            }

            async function checkForAutoSummary(chat) {
                if (!chat.enableAutoSummary || !chat.summaryTurnInterval || chat.summaryTurnInterval <= 0) {
                    return;
                }

                const lastSummaryIndex = chat.history.map(m => m.content).lastIndexOf('[system: memory_summary_checkpoint]');
                const historySinceLastSummary = lastSummaryIndex === -1 ? chat.history : chat.history.slice(lastSummaryIndex + 1);

                const turnCount = historySinceLastSummary.filter(m => m.role === 'user').length;

                if (turnCount >= chat.summaryTurnInterval) {
                    await triggerMemorySummary(chat, historySinceLastSummary);
                }
            }

            async function triggerMemorySummary(chat, historyToSummarize) {
                showToast('正在自动总结记忆...');
                const { url, key, model, provider } = db.apiSettings;
                if (!url || !key || !model) {
                    showToast('API未设置，无法进行总结。');
                    return;
                }

                let summaryPrompt = '';
                let conversationText = historyToSummarize
                    .filter(m => m.role === 'user' || m.role === 'assistant')
                    .map(m => m.content)
                    .join('\n');

                summaryPrompt = `你叫 ${chat.realName}。请根据以下你和 ${chat.myName} 的对话记录，以你的第一人称视角，写一段简明扼要的摘要，总结对话的关键信息和进展。
                
                重要规则：
                1. 摘要必须控制在300字以内。
                2. **不要在摘要开头或文中提及具体的日期（如“11月11日”、“今天”等），因为系统已经在外部记录了时间戳。直接描述发生了什么事情即可。**
                3. 只输出摘要内容，不要有任何额外的话。

                对话记录：
                ${conversationText}`;

                try {
                    let requestBody, endpoint, headers;
                    if (provider === 'gemini') {
                        requestBody = { contents: [{ parts: [{ text: summaryPrompt }] }] };
                        endpoint = `${url}/v1beta/models/${model}:generateContent?key=${getRandomValue(key)}`;
                        headers = { 'Content-Type': 'application/json' };
                    } else {
                        requestBody = { model: model, messages: [{ role: 'user', content: summaryPrompt }], stream: false };
                        endpoint = `${url}/v1/chat/completions`;
                        headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) throw new Error(`API 错误: ${response.status}`);

                    const data = await response.json();
                    let summaryText = '';
                    if (provider === 'gemini') {
                        summaryText = data.candidates[0].content.parts[0].text;
                    } else {
                        summaryText = data.choices[0].message.content;
                    }

                    const nowObj = new Date();
                    const timeString = `${nowObj.getFullYear()}年${nowObj.getMonth() + 1}月${nowObj.getDate()}号 ${pad(nowObj.getHours())}:${pad(nowObj.getMinutes())}`;

                    if (!chat.summaryHistory) chat.summaryHistory = [];

                    chat.summaryHistory.push({
                        id: Date.now(),
                        timestamp: timeString,
                        content: summaryText.trim()
                    });

                    chat.history.push({
                        id: `summary_checkpoint_${Date.now()}`,
                        role: 'system',
                        content: '[system: memory_summary_checkpoint]',
                        timestamp: Date.now()
                    });

                    await saveData();
                    showToast('记忆已自动总结并追加到列表。');

                    const summaryModal = document.getElementById('summary-manager-modal');
                    if (summaryModal && summaryModal.classList.contains('visible')) {
                        renderSummaryList(chat);
                    }

                } catch (error) {
                    console.error('自动总结失败:', error);
                    showToast(`自动总结失败: ${error.message}`);
                }
            }


            async function processStream(response, chat, apiType) {
                const reader = response.body.getReader(), decoder = new TextDecoder();
                let fullResponse = "", accumulatedChunk = "";
                for (; ;) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    accumulatedChunk += decoder.decode(value, { stream: true });
                    // 在 processStream 函数内，处理 openai/deepseek/newapi 的部分
                    if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi") {
                        const parts = accumulatedChunk.split("\n\n");
                        accumulatedChunk = parts.pop();
                        for (const part of parts) {
                            if (part.startsWith("data: ")) {
                                const data = part.substring(6);
                                if (data.trim() !== "[DONE]") {
                                    try {
                                        const json = JSON.parse(data);
                                        
                                        // --- 调试代码 START ---
                                        // 如果发现 returned JSON 里包含 error 字段，手动抛出错误
                                        if (json.error) {
                                            console.error("API返回了业务错误:", json.error);
                                            showToast(`API错误: ${json.error.message || JSON.stringify(json.error)}`);
                                            return; // 停止处理
                                        }
                                        // --- 调试代码 END ---
                    
                                        const delta = json.choices?.[0]?.delta;
                                        if (delta) {
                                            // 兼容 deepseek 的 reasoning_content (如果是推理模型)
                                            const content = delta.content || delta.reasoning_content || "";
                                            fullResponse += content;
                                        } else {
                                            console.warn("解析到没有 choices/delta 的包:", json);
                                        }
                                    } catch (e) {
                                        console.error("流解析出错:", e, "原始数据:", data);
                                    }
                                }
                            }
                        }
                    }
                }
                if (apiType === "gemini") {
                    // 使用正则从原始流数据中直接提取文本，避免 JSON.parse 解析不完整数据报错
                    try {
                        const textRegex = /"text":\s*"((?:[^"\\]|\\.)*)"/g;
                        let match;
                        fullResponse = ""; // 重置全量文本
                        while ((match = textRegex.exec(accumulatedChunk)) !== null) {
                            // 处理 JSON 转义字符
                            let segment = match[1]
                                .replace(/\\n/g, '\n')
                                .replace(/\\"/g, '"')
                                .replace(/\\\\/g, '\\')
                                .replace(/\\u([0-9a-fA-F]{4})/g, (match, grp) => String.fromCharCode(parseInt(grp, 16))); // 处理unicode
                            fullResponse += segment;
                        }
                    } catch (e) {
                        console.error("Gemini stream parsing error (ignoring):", e);
                    }
                }
                if (fullResponse) {
                    const character = chat;
                    const messages = getMixedContent(fullResponse)
                    if (messages.length > 0) {
                        messages.forEach(item => {
                            const message = {
                                id: `msg_${Date.now()}_${Math.random()}`,
                                role: 'assistant',
                                content: item.content.trim(),
                                parts: [{ type: item.type, text: item.content.trim() }],
                                timestamp: Date.now(),
                            };
                            chat.history.push(message);
                            addMessageBubble(message);
                        });
                    } else {
                        const simpleMessage = {
                            id: `msg_${Date.now()}_${Math.random()}`,
                            role: 'assistant',
                            content: fullResponse,
                            parts: [{ type: 'text', text: fullResponse }],
                            timestamp: Date.now()
                        };
                        chat.history.push(simpleMessage);
                        await addMessageBubble(simpleMessage);
                    }
                    await saveData();
                    renderChatList();
                }
            }

            function setupImageRecognition() {
                imageRecognitionBtn.addEventListener('click', () => {
                    imageUploadInput.click();
                });
                imageUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressedUrl = await compressImage(file, {
                                quality: 0.8,
                                maxWidth: 1024,
                                maxHeight: 1024
                            });
                            sendImageForRecognition(compressedUrl);
                        } catch (error) {
                            console.error('Image compression failed:', error);
                            showToast('图片处理失败，请重试');
                        } finally {
                            e.target.value = null;
                        }
                    }
                });
            }

            async function setupStickerSystem() {
                stickerToggleBtn.addEventListener('click', () => {
                    stickerModal.classList.toggle('visible');
                    if (stickerModal.classList.contains('visible')) {
                        renderStickerGrid();
                    }
                });
                addNewStickerBtn.addEventListener('click', () => {
                    addStickerModalTitle.textContent = '添加新表情';
                    addStickerForm.reset();
                    stickerEditIdInput.value = '';
                    stickerPreview.innerHTML = '<span>预览</span>';
                    stickerUrlInput.disabled = false;
                    addStickerModal.classList.add('visible');
                });
                addStickerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = stickerNameInput.value.trim();
                    const id = stickerEditIdInput.value;
                    const previewImg = stickerPreview.querySelector('img');
                    const data = previewImg ? previewImg.src : null;
                    if (!name || !data) {
                        return showToast('请填写表情名称并提供图片');
                    }
                    const stickerData = { name, data };
                    if (id) {
                        const index = db.myStickers.findIndex(s => s.id === id);
                        if (index > -1) {
                            db.myStickers[index] = { ...db.myStickers[index], ...stickerData };
                        }
                    } else {
                        stickerData.id = `sticker_${Date.now()}`;
                        db.myStickers.push(stickerData);
                    }
                    await saveData();
                    renderStickerGrid();
                    addStickerModal.classList.remove('visible');
                    showToast('表情包已保存');
                });
                stickerUrlInput.addEventListener('input', (e) => {
                    stickerPreview.innerHTML = `<img src="${e.target.value}" alt="预览">`;
                    stickerFileUpload.value = '';
                });
                stickerFileUpload.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                            stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="预览">`;
                            stickerUrlInput.value = '';
                            stickerUrlInput.disabled = true;
                        } catch (error) {
                            console.error('表情包压缩失败:', error);
                            showToast('表情包压缩失败，请重试');
                        }
                    }
                });
                editStickerBtn.addEventListener('click', () => {
                    if (!currentStickerActionTarget) return;
                    const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                    if (sticker) {
                        addStickerModalTitle.textContent = '编辑表情';
                        stickerEditIdInput.value = sticker.id;
                        stickerNameInput.value = sticker.name;
                        stickerPreview.innerHTML = `<img src="${sticker.data}" alt="预览">`;
                        if (sticker.data.startsWith('http')) {
                            stickerUrlInput.value = sticker.data;
                            stickerUrlInput.disabled = false;
                        } else {
                            stickerUrlInput.value = '';
                            stickerUrlInput.disabled = true;
                        }
                        addStickerModal.classList.add('visible');
                    }
                    stickerActionSheet.classList.remove('visible');
                    currentStickerActionTarget = null;
                });
                deleteStickerBtn.addEventListener('click', async () => {
                    if (!currentStickerActionTarget) return;
                    const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                    if (sticker) {
                        if (confirm(`确定要删除表情“${sticker.name}”吗？`)) {
                            db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                            await saveData();
                            renderStickerGrid();
                            showToast('表情已删除');
                        }
                    }
                    stickerActionSheet.classList.remove('visible');
                    currentStickerActionTarget = null;
                });
            }

            function renderStickerGrid() {
                stickerGridContainer.innerHTML = '';
                if (db.myStickers.length === 0) {
                    stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>';
                    return;
                }
                db.myStickers.forEach(sticker => {
                    const item = document.createElement('div');
                    item.className = 'sticker-item';
                    item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;
                    item.addEventListener('click', () => sendSticker(sticker));
                    item.addEventListener('mousedown', (e) => {
                        if (e.button !== 0) return;
                        e.stopPropagation();
                        longPressTimer = setTimeout(() => {
                            handleStickerLongPress(sticker.id);
                        }, 500);
                    });
                    item.addEventListener('mouseup', () => clearTimeout(longPressTimer));
                    item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
                    item.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                        longPressTimer = setTimeout(() => {
                            handleStickerLongPress(sticker.id);
                        }, 500);
                    });
                    item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                    item.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                    stickerGridContainer.appendChild(item);
                });
            }

            function handleStickerLongPress(stickerId) {
                clearTimeout(longPressTimer);
                currentStickerActionTarget = stickerId;
                stickerActionSheet.classList.add('visible');
            }

            function setupPhotoVideoSystem() {
                photoVideoBtn.addEventListener('click', () => {
                    sendPvForm.reset();
                    sendPvModal.classList.add('visible');
                });
                sendPvForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    sendMyPhotoVideo(pvTextInput.value.trim());
                });
            }

            function setupFontSettingsApp() {
                fontUrlInput.value = db.fontUrl;
                fontSettingsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newFontUrl = fontUrlInput.value.trim();
                    db.fontUrl = newFontUrl;
                    await saveData();
                    applyGlobalFont(newFontUrl);
                    showToast('新字体已应用！');
                });
                restoreDefaultFontBtn.addEventListener('click', async () => {
                    fontUrlInput.value = '';
                    db.fontUrl = '';
                    await saveData();
                    applyGlobalFont('');
                    showToast('已恢复默认字体！');
                });
            }

            function applyGlobalFont(fontUrl) {
                const styleId = 'global-font-style';
                let styleElement = document.getElementById(styleId);
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                if (fontUrl) {
                    const fontName = 'CustomGlobalFont';
                    styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
                } else {
                    styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
                }
            }

            function setupWorldBookApp() {
                addWorldBookBtn.addEventListener('click', () => {
                    currentEditingWorldBookId = null;
                    editWorldBookForm.reset();
                    document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                    switchScreen('edit-world-book-screen');
                });
                editWorldBookForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = worldBookNameInput.value.trim();
                    const content = worldBookContentInput.value.trim();
                    const position = document.querySelector('input[name="world-book-position"]:checked').value;
                    if (!name || !content) return showToast('名称和内容不能为空');
                    if (currentEditingWorldBookId) {
                        const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                        if (book) {
                            book.name = name;
                            book.content = content;
                            book.position = position;
                        }
                    } else {
                        db.worldBooks.push({ id: `wb_${Date.now()}`, name, content, position });
                    }
                    await saveData();
                    showToast('世界书条目已保存');
                    renderWorldBookList();
                    switchScreen('world-book-screen');
                });
                worldBookListContainer.addEventListener('click', e => {
                    const item = e.target.closest('.world-book-item');
                    if (item) {
                        const book = db.worldBooks.find(wb => wb.id === item.dataset.id);
                        if (book) {
                            currentEditingWorldBookId = book.id;
                            worldBookIdInput.value = book.id;
                            worldBookNameInput.value = book.name;
                            worldBookContentInput.value = book.content;
                            document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                            switchScreen('edit-world-book-screen');
                        }
                    }
                });

                worldBookListContainer.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const item = e.target.closest('.world-book-item');
                    if (!item) return;
                    handleWorldBookLongPress(item.dataset.id, e.clientX, e.clientY);
                });
                worldBookListContainer.addEventListener('touchstart', (e) => {
                    const item = e.target.closest('.world-book-item');
                    if (!item) return;
                    longPressTimer = setTimeout(() => {
                        const touch = e.touches[0];
                        handleWorldBookLongPress(item.dataset.id, touch.clientX, touch.clientY);
                    }, 500);
                });
                worldBookListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
                worldBookListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            }

            function handleWorldBookLongPress(bookId, x, y) {
                clearTimeout(longPressTimer);
                const menuItems = [{
                    label: '删除',
                    danger: true,
                    action: async () => {
                        if (confirm('确定要删除这个世界书条目吗？此操作不可恢复。')) {
                            db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);

                            db.characters.forEach(char => {
                                char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId);
                            });

                            await saveData();
                            renderWorldBookList();
                            showToast('条目已删除');
                        }
                    }
                }];
                createContextMenu(menuItems, x, y);
            }

            function renderWorldBookList() {
                worldBookListContainer.innerHTML = '';
                noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item world-book-item';
                    li.dataset.id = book.id;
                    li.innerHTML = `<div class="item-details" style="padding-left: 20px;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`;
                    worldBookListContainer.appendChild(li);
                });
            }

            function setupChatSettings() {
                const themeSelect = document.getElementById('setting-theme-color');
                themeSelect.innerHTML = '';
                Object.keys(colorThemes).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = colorThemes[key].name;
                    themeSelect.appendChild(option);
                });
                chatSettingsBtn.addEventListener('click', () => {
                    loadSettingsToSidebar();
                    settingsSidebar.classList.add('open');
                });
                document.querySelector('.phone-screen').addEventListener('click', e => {
                    const openSidebar = document.querySelector('.settings-sidebar.open');
                    if (openSidebar && !openSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target) && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {
                        openSidebar.classList.remove('open');
                    }
                });

                settingsForm.addEventListener('submit', e => {
                    e.preventDefault();
                    saveSettingsFromSidebar();
                    settingsSidebar.classList.remove('open');
                });
                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                    customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                    resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'),
                    privatePreviewBox = document.getElementById('private-bubble-css-preview');
                useCustomCssCheckbox.addEventListener('change', (e) => {
                    customCssTextarea.disabled = !e.target.checked;
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        const themeKey = char.theme || 'white_pink';
                        const theme = colorThemes[themeKey];
                        updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);
                    }
                });
                customCssTextarea.addEventListener('input', (e) => {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char && useCustomCssCheckbox.checked) {
                        const themeKey = char.theme || 'white_pink';
                        const theme = colorThemes[themeKey];
                        updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);
                    }
                });
                resetCustomCssBtn.addEventListener('click', () => {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        customCssTextarea.value = '';
                        useCustomCssCheckbox.checked = false;
                        customCssTextarea.disabled = true;
                        const themeKey = char.theme || 'white_pink';
                        const theme = colorThemes[themeKey];
                        updateBubbleCssPreview(privatePreviewBox, '', true, theme);
                        showToast('样式已重置为默认');
                    }
                });
                document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                            document.getElementById('setting-char-avatar-preview').src = compressedUrl;
                        } catch (error) {
                            showToast('头像压缩失败，请重试');
                        }
                    }
                });
                document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                            document.getElementById('setting-my-avatar-preview').src = compressedUrl;
                        } catch (error) {
                            showToast('头像压缩失败，请重试');
                        }
                    }
                });
                document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const char = db.characters.find(c => c.id === currentChatId);
                        if (char) {
                            try {
                                const compressedUrl = await compressImage(file, {
                                    quality: 0.85,
                                    maxWidth: 1080,
                                    maxHeight: 1920
                                });
                                char.chatBg = compressedUrl;
                                chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                                await saveData();
                                showToast('聊天背景已更换');
                            } catch (error) {
                                showToast('背景压缩失败，请重试');
                            }
                        }
                    }
                });
                clearChatHistoryBtn.addEventListener('click', async () => {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (!character) return;
                    if (confirm(`你确定要清空与“${character.remarkName}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                        character.history = [];
                        await saveData();
                        renderMessages(false, true);
                        renderChatList();
                        settingsSidebar.classList.remove('open');
                        showToast('聊天记录已清空');
                    }
                });
                linkWorldBookBtn.addEventListener('click', () => {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (!character) return;
                    worldBookSelectionList.innerHTML = '';
                    db.worldBooks.forEach(book => {
                        const li = document.createElement('li');
                        li.className = 'world-book-select-item';
                        const isChecked = (character.worldBookIds || []).includes(book.id);
                        li.innerHTML = `<input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label>`;
                        worldBookSelectionList.appendChild(li);
                    });
                    worldBookSelectionModal.classList.add('visible');
                });

                saveWorldBookSelectionBtn.addEventListener('click', async () => {
                    const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (character) character.worldBookIds = selectedIds;
                    await saveData();
                    worldBookSelectionModal.classList.remove('visible');
                    showToast('世界书关联已更新');
                });
            }

            const managePrivateBtn = document.getElementById('manage-summaries-btn');
            const summaryModal = document.getElementById('summary-manager-modal');
            const closeSummaryBtn = document.getElementById('close-summary-manager-btn');

            const openSummaryManager = () => {
                const chat = db.characters.find(c => c.id === currentChatId);
                if (chat) {
                    renderSummaryList(chat);
                    summaryModal.classList.add('visible');
                }
            };

            if (managePrivateBtn) managePrivateBtn.onclick = openSummaryManager;

            if (closeSummaryBtn) {
                closeSummaryBtn.onclick = () => {
                    summaryModal.classList.remove('visible');
                };
            }

            function loadSettingsToSidebar() {
                const e = db.characters.find(e => e.id === currentChatId);
                if (e) {
                    document.getElementById('setting-char-avatar-preview').src = e.avatar;
                    document.getElementById('setting-char-remark').value = e.remarkName;
                    document.getElementById('setting-char-persona').value = e.persona;
                    document.getElementById('setting-my-avatar-preview').src = e.myAvatar;
                    document.getElementById('setting-my-name').value = e.myName;
                    document.getElementById('setting-my-persona').value = e.myPersona;
                    document.getElementById('setting-theme-color').value = e.theme || 'white_pink';
                    document.getElementById('setting-max-memory').value = e.maxMemory;
                    const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                        customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                        privatePreviewBox = document.getElementById('private-bubble-css-preview');
                    useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;
                    customCssTextarea.value = e.customBubbleCss || '';
                    customCssTextarea.disabled = !useCustomCssCheckbox.checked;
                    const theme = colorThemes[e.theme || 'white_pink'];
                    updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);

                    document.getElementById('setting-auto-summary-toggle').checked = e.enableAutoSummary;
                    document.getElementById('setting-summary-interval').value = e.summaryTurnInterval;
                }
            }

            async function saveSettingsFromSidebar() {
                const e = db.characters.find(e => e.id === currentChatId);
                if (e) {
                    e.avatar = document.getElementById('setting-char-avatar-preview').src;
                    e.remarkName = document.getElementById('setting-char-remark').value;
                    e.persona = document.getElementById('setting-char-persona').value;
                    e.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                    e.myName = document.getElementById('setting-my-name').value;
                    e.myPersona = document.getElementById('setting-my-persona').value;
                    e.theme = document.getElementById('setting-theme-color').value;
                    e.maxMemory = parseInt(document.getElementById('setting-max-memory').value, 10);
                    e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
                    e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;

                    e.enableAutoSummary = document.getElementById('setting-auto-summary-toggle').checked;
                    e.summaryTurnInterval = parseInt(document.getElementById('setting-summary-interval').value, 10);

                    await saveData();

                    chatRoomScreen.setAttribute('data-theme', e.theme);

                    showToast('设置已保存！');
                    chatRoomTitle.textContent = e.remarkName;
                    renderChatList();
                    updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);
                    currentPage = 1;
                    renderMessages(false, true);
                }
            }

            function setupApiSettingsApp() {
                const e = document.getElementById('api-form'),
                    t = document.getElementById('fetch-models-btn'),
                    a = document.getElementById('api-model'),
                    n = document.getElementById('api-provider'),
                    r = document.getElementById('api-url'),
                    s = document.getElementById('api-key'),
                    tempInput = document.getElementById('api-temperature'),
                    tempDisplay = document.getElementById('temp-display-val'),
                    c = {
                        newapi: '',
                        deepseek: 'https://api.deepseek.com',
                        claude: 'https://api.anthropic.com',
                        gemini: 'https://generativelanguage.googleapis.com'
                    };

                if (db.apiSettings) {
                    n.value = db.apiSettings.provider || 'newapi';
                    r.value = db.apiSettings.url || '';
                    s.value = db.apiSettings.key || '';
                    if (db.apiSettings.model) {
                        a.innerHTML = `<option value="${db.apiSettings.model}">${db.apiSettings.model}</option>`;
                    }
                    const savedTemp = db.apiSettings.temperature !== undefined ? db.apiSettings.temperature : 1.0;
                    tempInput.value = savedTemp;
                    tempDisplay.textContent = savedTemp;
                }

                tempInput.addEventListener('input', (e) => {
                    tempDisplay.textContent = e.target.value;
                });

                n.addEventListener('change', () => {
                    r.value = c[n.value] || ''
                });

                t.addEventListener('click', async () => {
                    let o = r.value.trim();
                    const l = s.value.trim();
                    if (!o || !l) return showToast('请先填写API地址和密钥！');
                    o.endsWith('/') && (o = o.slice(0, -1));
                    const i = 'gemini' === n.value ? `${o}/v1beta/models?key=${getRandomValue(l)}` : `${o}/v1/models`;
                    t.classList.add('loading'), t.disabled = !0;
                    try {
                        const d = 'gemini' === n.value ? {} : {
                            Authorization: `Bearer ${l}`
                        },
                            g = await fetch(i, {
                                method: 'GET',
                                headers: d
                            });
                        if (!g.ok) throw new Error(`网络响应错误: ${g.status}`);
                        const u = await g.json();
                        let p = [];
                        'gemini' !== n.value && u.data ? p = u.data.map(e => e.id) : 'gemini' === n.value && u.models && (p = u.models.map(e => e.name.replace('models/', ''))), a.innerHTML = '', p.length > 0 ? p.forEach(e => {
                            const t = document.createElement('option');
                            t.value = e, t.textContent = e, a.appendChild(t)
                        }) : a.innerHTML = '<option value="">未找到任何模型</option>', showToast('模型列表拉取成功！')
                    } catch (f) {
                        showToast(`拉取失败: ${f.message}`), a.innerHTML = '<option value="">拉取失败</option>'
                    } finally {
                        t.classList.remove('loading'), t.disabled = !1
                    }
                });

                e.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!a.value) return showToast('请选择模型后保存！');

                    db.apiSettings = {
                        provider: n.value,
                        url: r.value,
                        key: s.value,
                        model: a.value,
                        temperature: parseFloat(tempInput.value)
                    };
                    await saveData();
                    showToast('API设置已保存！')
                })
            }

            function setupWallpaperApp() {
                const e = document.getElementById('wallpaper-upload'), t = document.getElementById('wallpaper-preview');
                t.style.backgroundImage = `url(${db.wallpaper})`, t.textContent = '', e.addEventListener('change', async (a) => {
                    const n = a.target.files[0];
                    if (n) {
                        try {
                            const r = await compressImage(n, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                            db.wallpaper = r, applyWallpaper(r), t.style.backgroundImage = `url(${r})`;
                            await saveData();
                            showToast('壁纸更换成功！');
                        } catch (s) {
                            showToast('壁纸压缩失败，请重试');
                        }
                    }
                });
            }

            function renderSummaryList(chat) {
                const container = document.getElementById('summary-list-container');
                container.innerHTML = '';

                if (!chat.summaryHistory || chat.summaryHistory.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">暂无自动总结记录</p>';
                    return;
                }

                const list = [...chat.summaryHistory].reverse();

                list.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'summary-card';

                    card.innerHTML = `
                    <div class="summary-header">
                        <span class="summary-time">${item.timestamp}</span>
                        <div class="summary-actions">
                            <button class="summary-btn edit-sum-btn">编辑</button>
                            <button class="summary-btn del-sum-btn">删除</button>
                        </div>
                    </div>
                    <div class="summary-content">${item.content}</div>
                `;

                    card.querySelector('.del-sum-btn').addEventListener('click', async () => {
                        if (confirm('确定要删除这条记忆吗？')) {
                            chat.summaryHistory = chat.summaryHistory.filter(i => i.id !== item.id);
                            await saveData();
                            renderSummaryList(chat);
                        }
                    });

                    card.querySelector('.edit-sum-btn').addEventListener('click', async () => {
                        const newContent = prompt("编辑总结内容", item.content);
                        if (newContent !== null && newContent.trim() !== "") {
                            item.content = newContent.trim();
                            await saveData();
                            renderSummaryList(chat);
                        }
                    });

                    container.appendChild(card);
                });
            }

            function setupImportSystem() {
                const importInput = document.getElementById('import-data-input');

                const newImportInput = importInput.cloneNode(true);
                importInput.parentNode.replaceChild(newImportInput, importInput);

                newImportInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    showToast('正在解析备份文件...');

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const jsonString = event.target.result;
                            const importedData = JSON.parse(jsonString);

                            if (!importedData.characters && !importedData.apiSettings) {
                                throw new Error('无效的备份文件格式');
                            }

                            await saveData(importedData);

                            showToast('导入成功！正在重启应用...');

                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);

                        } catch (error) {
                            console.error('导入失败:', error);
                            showToast(`导入失败: ${error.message}`);
                        } finally {
                            e.target.value = '';
                        }
                    };

                    reader.onerror = () => {
                        showToast('读取文件出错');
                        e.target.value = '';
                    };

                    reader.readAsText(file);
                });
            }

            init();
        });
    </script>
</body>

</html>